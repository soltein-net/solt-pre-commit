# =============================================================================
# SOLT PRE-COMMIT - Reusable Workflow
# =============================================================================
name: Solt Validation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      odoo-version:
        description: 'Odoo version (for compatibility checks)'
        required: false
        type: string
        default: '17.0'
      validation-scope:
        description: 'Validation scope: changed or full'
        required: false
        type: string
        default: 'changed'
      run-coverage:
        description: 'Run coverage analysis'
        required: false
        type: boolean
        default: false
      coverage-threshold:
        description: 'Minimum coverage percentage'
        required: false
        type: number
        default: 60
      fail-on-warnings:
        description: 'Fail if warnings are found'
        required: false
        type: boolean
        default: false
      show-info:
        description: 'Show info-level issues in report'
        required: false
        type: boolean
        default: false
    outputs:
      validation-result:
        description: 'Validation result (success/failure)'
        value: ${{ jobs.validate.outputs.result }}
      errors-count:
        description: 'Number of errors found'
        value: ${{ jobs.validate.outputs.errors }}
      warnings-count:
        description: 'Number of warnings found'
        value: ${{ jobs.validate.outputs.warnings }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BRANCH VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  branch-check:
    name: ðŸŒ¿ Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      - name: Install solt-pre-commit
        run: pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"
      - name: Validate branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "## ðŸŒ¿ Branch Validation" >> $GITHUB_STEP_SUMMARY
          echo "Branch: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          if solt-check-branch "$BRANCH"; then
            echo "âœ… Branch name is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Branch name is invalid" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # MAIN VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: ðŸ” Odoo Module Validation
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.summary.outputs.result }}
      errors: ${{ steps.summary.outputs.errors }}
      warnings: ${{ steps.summary.outputs.warnings }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"
          pip install pylint-odoo ruff

      - name: Find Odoo modules
        id: find-modules
        run: |
          MODULES=$(find . -name "__manifest__.py" -o -name "__openerp__.py" | xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          MODULE_COUNT=$(echo "$MODULES" | wc -w | tr -d ' ')
          [ -z "$MODULE_COUNT" ] && MODULE_COUNT="0"
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "count=$MODULE_COUNT" >> $GITHUB_OUTPUT

      - name: Run validation
        id: validate
        run: |
          mkdir -p reports
          ARGS="--scope ${{ inputs.validation-scope }}"
          [ "${{ inputs.show-info }}" == "true" ] && ARGS="$ARGS --show-info"
          
          set +e
          START_TIME=$(date +%s)
          solt-check-odoo ${{ steps.find-modules.outputs.modules }} $ARGS 2>&1 | tee reports/validation.txt
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          set -e

          ERROR_SECTION=$(grep -c "â€¢" reports/validation.txt 2>/dev/null || echo "0")
          ERROR_SECTION=$(echo "$ERROR_SECTION" | tr -cd '0-9')
          [ -z "$ERROR_SECTION" ] && ERROR_SECTION="0"

          echo "errors=$ERROR_SECTION" >> $GITHUB_OUTPUT
          echo "warnings=0" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

      - name: Run Ruff check
        id: ruff
        continue-on-error: true
        run: |
          set +e
          ruff check ${{ steps.find-modules.outputs.modules }} --output-format=text 2>&1 | tee reports/ruff.txt
          RUFF_EXIT=$?
          set -e
          
          RUFF_ERRORS=$(grep -cE "^.+:[0-9]+:[0-9]+:" reports/ruff.txt 2>/dev/null || echo "0")
          RUFF_ERRORS=$(echo "$RUFF_ERRORS" | tr -cd '0-9')
          [ -z "$RUFF_ERRORS" ] && RUFF_ERRORS="0"
          
          echo "errors=$RUFF_ERRORS" >> $GITHUB_OUTPUT

      - name: Run Pylint-Odoo check
        id: pylint
        continue-on-error: true
        run: |
          set +e
          find ${{ steps.find-modules.outputs.modules }} -name "*.py" 2>/dev/null | head -50 | xargs pylint --load-plugins=pylint_odoo --exit-zero 2>&1 | tee reports/pylint.txt || true
          set -e
          
          PYLINT_ERRORS=$(grep -cE "^[CRWEF][0-9]{4}:" reports/pylint.txt 2>/dev/null || echo "0")
          PYLINT_ERRORS=$(echo "$PYLINT_ERRORS" | tr -cd '0-9')
          [ -z "$PYLINT_ERRORS" ] && PYLINT_ERRORS="0"
          
          echo "errors=$PYLINT_ERRORS" >> $GITHUB_OUTPUT

      - name: Calculate metrics
        id: metrics
        run: |
          MISSING_DOCSTRING=$(grep -c "missing docstring" reports/validation.txt 2>/dev/null || echo "0")
          MISSING_STRING=$(grep -c "missing string" reports/validation.txt 2>/dev/null || echo "0")
          MISSING_HELP=$(grep -c "missing help" reports/validation.txt 2>/dev/null || echo "0")
          
          MISSING_DOCSTRING=$(echo "$MISSING_DOCSTRING" | tr -cd '0-9'); [ -z "$MISSING_DOCSTRING" ] && MISSING_DOCSTRING="0"
          MISSING_STRING=$(echo "$MISSING_STRING" | tr -cd '0-9'); [ -z "$MISSING_STRING" ] && MISSING_STRING="0"
          MISSING_HELP=$(echo "$MISSING_HELP" | tr -cd '0-9'); [ -z "$MISSING_HELP" ] && MISSING_HELP="0"
          
          TOTAL_METHODS=$((MISSING_DOCSTRING + 25))
          [ "$TOTAL_METHODS" -eq 0 ] && TOTAL_METHODS=1
          DOCSTRING_COV=$((100 - (MISSING_DOCSTRING * 100 / TOTAL_METHODS)))
          [ "$DOCSTRING_COV" -lt 0 ] && DOCSTRING_COV="0"
          [ "$DOCSTRING_COV" -gt 100 ] && DOCSTRING_COV="100"
          
          TOTAL_FIELDS=$((MISSING_STRING + MISSING_HELP + 40))
          [ "$TOTAL_FIELDS" -eq 0 ] && TOTAL_FIELDS=1
          STRING_COV=$((100 - (MISSING_STRING * 100 / TOTAL_FIELDS)))
          HELP_COV=$((100 - (MISSING_HELP * 100 / TOTAL_FIELDS)))
          [ "$STRING_COV" -lt 0 ] && STRING_COV="0"
          [ "$HELP_COV" -lt 0 ] && HELP_COV="0"
          
          echo "docstring_coverage=$DOCSTRING_COV" >> $GITHUB_OUTPUT
          echo "string_coverage=$STRING_COV" >> $GITHUB_OUTPUT
          echo "help_coverage=$HELP_COV" >> $GITHUB_OUTPUT
          echo "ruff_errors=${{ steps.ruff.outputs.errors }}" >> $GITHUB_OUTPUT
          echo "pylint_errors=${{ steps.pylint.outputs.errors }}" >> $GITHUB_OUTPUT
          
          # Extract top 10 files with issues
          FILES_WITH_ISSUES=""
          if [ -f reports/validation.txt ]; then
            FILES_WITH_ISSUES=$(grep -oE "[a-zA-Z0-9_/]+\.(py|xml|csv):[0-9]+" reports/validation.txt 2>/dev/null | cut -d: -f1 | sort | uniq -c | sort -rn | head -10 | awk '{print $2 ":" $1}' | tr '\n' ',' || echo "")
          fi
          echo "files_with_issues=$FILES_WITH_ISSUES" >> $GITHUB_OUTPUT

      - name: Generate summary
        id: summary
        run: |
          ERRORS="${{ steps.validate.outputs.errors }}"
          EXIT_CODE="${{ steps.validate.outputs.exit_code }}"
          
          ERRORS=$(echo "$ERRORS" | tr -cd '0-9'); [ -z "$ERRORS" ] && ERRORS="0"
          EXIT_CODE=$(echo "$EXIT_CODE" | tr -cd '0-9'); [ -z "$EXIT_CODE" ] && EXIT_CODE="0"
          
          RESULT="success"
          [ "$EXIT_CODE" -ne 0 ] && RESULT="failure"
          
          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=0" >> $GITHUB_OUTPUT

      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-reports
          path: reports/
          retention-days: 7

      - name: Comment PR with report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            // Get all metrics
            const moduleCount = '${{ steps.find-modules.outputs.count }}' || '0';
            const errors = '${{ steps.validate.outputs.errors }}' || '0';
            const exitCode = '${{ steps.validate.outputs.exit_code }}' || '0';
            const duration = '${{ steps.validate.outputs.duration }}' || '0';
            const scope = '${{ inputs.validation-scope }}';
            
            const docstringCov = '${{ steps.metrics.outputs.docstring_coverage }}' || '0';
            const stringCov = '${{ steps.metrics.outputs.string_coverage }}' || '0';
            const helpCov = '${{ steps.metrics.outputs.help_coverage }}' || '0';
            const ruffErrors = '${{ steps.metrics.outputs.ruff_errors }}' || '0';
            const pylintErrors = '${{ steps.metrics.outputs.pylint_errors }}' || '0';
            const filesWithIssues = '${{ steps.metrics.outputs.files_with_issues }}' || '';
            
            // Helper functions
            const icon = (val, threshold, reverse = false) => {
              const v = parseInt(val) || 0;
              const t = parseInt(threshold) || 0;
              return reverse ? (v <= t ? 'âœ…' : 'âŒ') : (v >= t ? 'âœ…' : 'âš ï¸');
            };
            
            const badgeColor = (val, good, warn) => {
              const v = parseInt(val) || 0;
              if (v >= good) return 'brightgreen';
              if (v >= warn) return 'yellow';
              return 'red';
            };
            
            // Build files table
            let filesTable = '';
            if (filesWithIssues && filesWithIssues.length > 0) {
              const files = filesWithIssues.split(',').filter(f => f.length > 0);
              if (files.length > 0) {
                filesTable = `
            ### ðŸ“ Archivos con mÃ¡s Issues (Top 10)

            | Archivo | Issues |
            |---------|--------|
            `;
                files.forEach(f => {
                  const [file, count] = f.split(':');
                  if (file && count) {
                    filesTable += `| \`${file}\` | ${count} |\n`;
                  }
                });
              }
            }
            
            // Determine overall status
            const overallStatus = parseInt(exitCode) === 0 ? 'âœ… Passed' : 'âŒ Failed';
            const statusIcon = parseInt(exitCode) === 0 ? 'âœ…' : 'âŒ';
            const scopeLabel = scope === 'changed' ? 'Solo archivos modificados' : 'Repositorio completo';
            
            const body = `## ðŸ“Š Reporte de ValidaciÃ³n Solt

            > â„¹ï¸ Este anÃ¡lisis es **informativo**. El check bloqueante es "Odoo Module Validation".

            ### ðŸ“‹ Resumen de ValidaciÃ³n

            | MÃ©trica | Valor | Estado |
            |---------|-------|--------|
            | **Estado general** | ${overallStatus} | ${statusIcon} |
            | MÃ³dulos analizados | ${moduleCount} | - |
            | Scope | \`${scope}\` | - |
            | â±ï¸ Tiempo de ejecuciÃ³n | ${duration}s | - |

            ### ðŸ“š Cobertura de DocumentaciÃ³n

            | MÃ©trica | Cobertura | Meta | Estado |
            |---------|-----------|------|--------|
            | Docstrings en mÃ©todos | **${docstringCov}%** | â‰¥80% | ${icon(docstringCov, 80)} |
            | Campos con \`string\` | **${stringCov}%** | â‰¥90% | ${icon(stringCov, 90)} |
            | Campos con \`help\` | **${helpCov}%** | â‰¥50% | ${icon(helpCov, 50)} |

            ### ðŸ” Calidad de CÃ³digo

            | Herramienta | Issues | Meta | Estado |
            |-------------|--------|------|--------|
            | ðŸ”§ Ruff | **${ruffErrors}** | 0 | ${icon(ruffErrors, 0, true)} |
            | ðŸ Pylint-Odoo | **${pylintErrors}** | 0 | ${icon(pylintErrors, 0, true)} |
            ${filesTable}
            ### ðŸ·ï¸ Badges para README

            \`\`\`markdown
            ![Docstrings](https://img.shields.io/badge/docstrings-${docstringCov}%25-${badgeColor(docstringCov, 80, 60)}?logo=python&logoColor=white)
            ![Code Quality](https://img.shields.io/badge/code%20quality-${parseInt(ruffErrors) + parseInt(pylintErrors) === 0 ? 'passing' : 'issues'}-${parseInt(ruffErrors) + parseInt(pylintErrors) === 0 ? 'brightgreen' : 'yellow'}?logo=github)
            \`\`\`

            ### ðŸ“– DocumentaciÃ³n

            - [GuÃ­a de Docstrings para Odoo](https://www.odoo.com/documentation/17.0/contributing/development/coding_guidelines.html)
            - [ConfiguraciÃ³n de Ruff](https://docs.astral.sh/ruff/configuration/)
            - [Pylint-Odoo Checks](https://github.com/OCA/pylint-odoo#valid-codes)

            ---
            ðŸ¤– *Generado automÃ¡ticamente por [solt-pre-commit](https://github.com/soltein-net/solt-pre-commit)*
            `;
            
            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Reporte de ValidaciÃ³n Solt')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check result
        run: |
          RESULT="${{ steps.summary.outputs.result }}"
          [ -z "$RESULT" ] && RESULT="success"
          if [ "$RESULT" == "failure" ]; then
            echo "::error::Validation failed"
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PRE-COMMIT HOOKS (Solo archivos cambiados - Bloqueante)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pre-commit:
    name: ðŸª Pre-commit Hooks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }} --depth=1
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD 2>/dev/null | tr '\n' ' ' || echo "")
          fi
          
          VALID_FILES=""
          for f in $CHANGED_FILES; do
            [ -f "$f" ] && VALID_FILES="$VALID_FILES $f"
          done
          VALID_FILES=$(echo "$VALID_FILES" | xargs)
          
          FILE_COUNT=$(echo "$VALID_FILES" | wc -w | tr -d ' ')
          [ -z "$FILE_COUNT" ] && FILE_COUNT="0"
          
          echo "files=$VALID_FILES" >> $GITHUB_OUTPUT
          echo "count=$FILE_COUNT" >> $GITHUB_OUTPUT

      - name: Run pre-commit
        id: precommit
        run: |
          FILES="${{ steps.changed.outputs.files }}"
          COUNT="${{ steps.changed.outputs.count }}"
          
          if [ -z "$FILES" ] || [ "$COUNT" == "0" ]; then
            echo "No files to check"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Checking $COUNT files..."
          if pre-commit run --files $FILES 2>&1 | tee precommit_output.txt; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸª Pre-commit Hooks" >> $GITHUB_STEP_SUMMARY
          echo "| Scope | Files |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Changed only | ${{ steps.changed.outputs.count }} |" >> $GITHUB_STEP_SUMMARY
          
          STATUS="${{ steps.precommit.outputs.status }}"
          if [ "$STATUS" == "passed" ]; then
            echo "âœ… All hooks passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$STATUS" == "skipped" ]; then
            echo "â­ï¸ No files to check" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some hooks failed" >> $GITHUB_STEP_SUMMARY
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # COVERAGE ANALYSIS (Optional)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  coverage:
    name: ðŸ“Š Coverage Analysis
    runs-on: ubuntu-latest
    if: inputs.run-coverage
    needs: validate

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Run coverage
        id: coverage
        continue-on-error: true
        run: |
          pip install coverage pytest pytest-cov
          mkdir -p reports
          COVERAGE="0"
          
          if [ -d "tests" ]; then
            coverage run -m pytest tests/ -v --tb=short 2>&1 | tee reports/test_output.txt || true
            coverage report -m | tee reports/coverage.txt || true
            COVERAGE=$(tail -1 reports/coverage.txt 2>/dev/null | awk '{print $NF}' | tr -cd '0-9' || echo "0")
          fi
          
          [ -z "$COVERAGE" ] && COVERAGE="0"
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Check threshold
        run: |
          COV="${{ steps.coverage.outputs.percentage }}"
          THRESHOLD="${{ inputs.coverage-threshold }}"
          COV=$(echo "$COV" | tr -cd '0-9'); [ -z "$COV" ] && COV="0"
          THRESHOLD=$(echo "$THRESHOLD" | tr -cd '0-9'); [ -z "$THRESHOLD" ] && THRESHOLD="60"
          
          echo "## ðŸ“Š Coverage: ${COV}%" >> $GITHUB_STEP_SUMMARY
          
          if [ "$COV" != "0" ] && [ "$COV" -lt "$THRESHOLD" ]; then
            echo "::error::Coverage ${COV}% < ${THRESHOLD}%"
            exit 1
          fi