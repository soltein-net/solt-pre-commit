# =============================================================================
# SOLT PRE-COMMIT - Reusable Workflow
# =============================================================================
name: Solt Validation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      odoo-version:
        description: 'Odoo version (for compatibility checks)'
        required: false
        type: string
        default: '17.0'
      validation-scope:
        description: 'Validation scope: changed or full'
        required: false
        type: string
        default: 'changed'
      run-coverage:
        description: 'Run coverage analysis'
        required: false
        type: boolean
        default: false
      coverage-threshold:
        description: 'Minimum coverage percentage'
        required: false
        type: number
        default: 60
      fail-on-warnings:
        description: 'Fail if warnings are found'
        required: false
        type: boolean
        default: false
      show-info:
        description: 'Show info-level issues in report'
        required: false
        type: boolean
        default: false
    outputs:
      validation-result:
        description: 'Validation result (success/failure)'
        value: ${{ jobs.validate.outputs.result }}
      errors-count:
        description: 'Number of errors found'
        value: ${{ jobs.validate.outputs.errors }}
      warnings-count:
        description: 'Number of warnings found'
        value: ${{ jobs.validate.outputs.warnings }}

jobs:
  # ---------------------------------------------------------------------------
  # BRANCH VALIDATION
  # ---------------------------------------------------------------------------
  branch-check:
    name: Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      - name: Install solt-pre-commit
        run: pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"
      - name: Validate branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "## Branch Validation" >> $GITHUB_STEP_SUMMARY
          echo "Branch: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          if solt-check-branch "$BRANCH"; then
            echo "Branch name is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "Branch name is invalid" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ---------------------------------------------------------------------------
  # MAIN VALIDATION
  # ---------------------------------------------------------------------------
  validate:
    name: Odoo Module Validation
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.summary.outputs.result }}
      errors: ${{ steps.summary.outputs.errors }}
      warnings: ${{ steps.summary.outputs.warnings }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"
          pip install pylint-odoo ruff

      - name: Find Odoo modules
        id: find-modules
        run: |
          MODULES=$(find . -name "__manifest__.py" -o -name "__openerp__.py" | xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          MODULE_COUNT=$(echo "$MODULES" | wc -w | tr -d ' ')
          MODULE_COUNT="${MODULE_COUNT:-0}"
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "count=$MODULE_COUNT" >> $GITHUB_OUTPUT

      - name: Run validation
        id: validate
        run: |
          mkdir -p reports
          ARGS="--scope ${{ inputs.validation-scope }}"
          if [ "${{ inputs.show-info }}" == "true" ]; then
            ARGS="$ARGS --show-info"
          fi
          
          set +e
          START_TIME=$(date +%s)
          solt-check-odoo ${{ steps.find-modules.outputs.modules }} $ARGS 2>&1 | tee reports/validation.txt
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          set -e

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT

      - name: Run full validation for metrics
        id: validate-full
        run: |
          solt-check-odoo ${{ steps.find-modules.outputs.modules }} --scope full --show-info 2>&1 | tee reports/validation-full.txt || true

      - name: Run Ruff check
        id: ruff
        continue-on-error: true
        run: |
          set +e
          
          # Get changed Python files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }} --depth=1 2>/dev/null || true
            CHANGED_PY=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ' || echo "")
          else
            CHANGED_PY=$(git diff --name-only HEAD~1...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ' || echo "")
          fi
          
          RUFF_CHANGED=0
          if [ -n "$CHANGED_PY" ]; then
            # Use 'concise' format instead of 'text'
            ruff check $CHANGED_PY --output-format=concise 2>&1 | tee reports/ruff-changed.txt || true
            RUFF_CHANGED=$(grep -cE "^.+:[0-9]+:[0-9]+:" reports/ruff-changed.txt 2>/dev/null || echo "0")
          fi
          
          # Full repo - use 'concise' format
          ruff check ${{ steps.find-modules.outputs.modules }} --output-format=concise 2>&1 | tee reports/ruff-full.txt || true
          RUFF_FULL=$(grep -cE "^.+:[0-9]+:[0-9]+:" reports/ruff-full.txt 2>/dev/null || echo "0")
          
          # Ensure we have valid numbers
          RUFF_CHANGED="${RUFF_CHANGED:-0}"
          RUFF_FULL="${RUFF_FULL:-0}"
          
          set -e
          echo "changed=$RUFF_CHANGED" >> $GITHUB_OUTPUT
          echo "full=$RUFF_FULL" >> $GITHUB_OUTPUT

      - name: Run Pylint-Odoo check
        id: pylint
        continue-on-error: true
        run: |
          set +e
          
          # Get changed Python files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_PY=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ' || echo "")
          else
            CHANGED_PY=$(git diff --name-only HEAD~1...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ' || echo "")
          fi
          
          PYLINT_CHANGED=0
          if [ -n "$CHANGED_PY" ]; then
            echo "$CHANGED_PY" | xargs pylint --load-plugins=pylint_odoo --exit-zero 2>&1 | tee reports/pylint-changed.txt || true
            PYLINT_CHANGED=$(grep -cE "^[CRWEF][0-9]{4}:" reports/pylint-changed.txt 2>/dev/null || echo "0")
          fi
          
          # Full repo
          find ${{ steps.find-modules.outputs.modules }} -name "*.py" -not -path "*/__pycache__/*" 2>/dev/null | head -100 | xargs pylint --load-plugins=pylint_odoo --exit-zero 2>&1 | tee reports/pylint-full.txt || true
          PYLINT_FULL=$(grep -cE "^[CRWEF][0-9]{4}:" reports/pylint-full.txt 2>/dev/null || echo "0")
          
          # Ensure we have valid numbers
          PYLINT_CHANGED="${PYLINT_CHANGED:-0}"
          PYLINT_FULL="${PYLINT_FULL:-0}"
          
          set -e
          echo "changed=$PYLINT_CHANGED" >> $GITHUB_OUTPUT
          echo "full=$PYLINT_FULL" >> $GITHUB_OUTPUT

      - name: Calculate real metrics
        id: metrics
        run: |
          # Count REAL issues from validation output with safe defaults
          # PR scope (from validation.txt)
          MISSING_DOCSTRING_PR=$(grep -c "missing docstring" reports/validation.txt 2>/dev/null || echo "0")
          MISSING_STRING_PR=$(grep -c "missing string" reports/validation.txt 2>/dev/null || echo "0")
          MISSING_HELP_PR=$(grep -c "missing help" reports/validation.txt 2>/dev/null || echo "0")
          
          # Full repo (from validation-full.txt)
          MISSING_DOCSTRING_FULL=$(grep -c "missing docstring" reports/validation-full.txt 2>/dev/null || echo "0")
          MISSING_STRING_FULL=$(grep -c "missing string" reports/validation-full.txt 2>/dev/null || echo "0")
          MISSING_HELP_FULL=$(grep -c "missing help" reports/validation-full.txt 2>/dev/null || echo "0")
          
          # Count total methods and fields by analyzing Python files
          TOTAL_METHODS=$(find ${{ steps.find-modules.outputs.modules }} -name "*.py" -not -path "*/__pycache__/*" -exec grep -l "def " {} \; 2>/dev/null | xargs grep -c "def " 2>/dev/null | awk -F: '{sum+=$2} END {print sum+0}' || echo "1")
          TOTAL_FIELDS=$(find ${{ steps.find-modules.outputs.modules }} -name "*.py" -not -path "*/__pycache__/*" -exec grep -l "fields\." {} \; 2>/dev/null | xargs grep -c "fields\." 2>/dev/null | awk -F: '{sum+=$2} END {print sum+0}' || echo "1")
          
          # Ensure we have valid numbers (minimum 1 to avoid division by zero)
          TOTAL_METHODS=$((TOTAL_METHODS > 0 ? TOTAL_METHODS : 1))
          TOTAL_FIELDS=$((TOTAL_FIELDS > 0 ? TOTAL_FIELDS : 1))
          
          # Ensure issue counts are valid numbers
          MISSING_DOCSTRING_FULL=$((MISSING_DOCSTRING_FULL + 0))
          MISSING_STRING_FULL=$((MISSING_STRING_FULL + 0))
          MISSING_HELP_FULL=$((MISSING_HELP_FULL + 0))
          
          # Calculate documented counts (ensure non-negative)
          DOCUMENTED_METHODS=$((TOTAL_METHODS - MISSING_DOCSTRING_FULL))
          DOCUMENTED_METHODS=$((DOCUMENTED_METHODS > 0 ? DOCUMENTED_METHODS : 0))
          
          FIELDS_WITH_STRING=$((TOTAL_FIELDS - MISSING_STRING_FULL))
          FIELDS_WITH_STRING=$((FIELDS_WITH_STRING > 0 ? FIELDS_WITH_STRING : 0))
          
          FIELDS_WITH_HELP=$((TOTAL_FIELDS - MISSING_HELP_FULL))
          FIELDS_WITH_HELP=$((FIELDS_WITH_HELP > 0 ? FIELDS_WITH_HELP : 0))
          
          # Calculate percentages (safe division)
          DOCSTRING_COV=$((DOCUMENTED_METHODS * 100 / TOTAL_METHODS))
          STRING_COV=$((FIELDS_WITH_STRING * 100 / TOTAL_FIELDS))
          HELP_COV=$((FIELDS_WITH_HELP * 100 / TOTAL_FIELDS))
          
          # Clamp to 0-100
          DOCSTRING_COV=$((DOCSTRING_COV < 0 ? 0 : (DOCSTRING_COV > 100 ? 100 : DOCSTRING_COV)))
          STRING_COV=$((STRING_COV < 0 ? 0 : (STRING_COV > 100 ? 100 : STRING_COV)))
          HELP_COV=$((HELP_COV < 0 ? 0 : (HELP_COV > 100 ? 100 : HELP_COV)))
          
          # Get ruff/pylint values with defaults
          RUFF_CHANGED="${{ steps.ruff.outputs.changed }}"
          RUFF_FULL="${{ steps.ruff.outputs.full }}"
          PYLINT_CHANGED="${{ steps.pylint.outputs.changed }}"
          PYLINT_FULL="${{ steps.pylint.outputs.full }}"
          
          RUFF_CHANGED="${RUFF_CHANGED:-0}"
          RUFF_FULL="${RUFF_FULL:-0}"
          PYLINT_CHANGED="${PYLINT_CHANGED:-0}"
          PYLINT_FULL="${PYLINT_FULL:-0}"
          
          # Output all metrics
          echo "total_methods=$TOTAL_METHODS" >> $GITHUB_OUTPUT
          echo "total_fields=$TOTAL_FIELDS" >> $GITHUB_OUTPUT
          echo "documented_methods=$DOCUMENTED_METHODS" >> $GITHUB_OUTPUT
          echo "fields_with_string=$FIELDS_WITH_STRING" >> $GITHUB_OUTPUT
          echo "fields_with_help=$FIELDS_WITH_HELP" >> $GITHUB_OUTPUT
          echo "docstring_cov=$DOCSTRING_COV" >> $GITHUB_OUTPUT
          echo "string_cov=$STRING_COV" >> $GITHUB_OUTPUT
          echo "help_cov=$HELP_COV" >> $GITHUB_OUTPUT
          echo "missing_docstring_pr=${MISSING_DOCSTRING_PR:-0}" >> $GITHUB_OUTPUT
          echo "missing_string_pr=${MISSING_STRING_PR:-0}" >> $GITHUB_OUTPUT
          echo "missing_help_pr=${MISSING_HELP_PR:-0}" >> $GITHUB_OUTPUT
          echo "ruff_changed=$RUFF_CHANGED" >> $GITHUB_OUTPUT
          echo "ruff_full=$RUFF_FULL" >> $GITHUB_OUTPUT
          echo "pylint_changed=$PYLINT_CHANGED" >> $GITHUB_OUTPUT
          echo "pylint_full=$PYLINT_FULL" >> $GITHUB_OUTPUT

      - name: Generate summary
        id: summary
        run: |
          EXIT_CODE="${{ steps.validate.outputs.exit_code }}"
          EXIT_CODE=$(echo "$EXIT_CODE" | tr -cd '0-9')
          EXIT_CODE="${EXIT_CODE:-0}"
          
          if [ "$EXIT_CODE" -ne 0 ] 2>/dev/null; then
            RESULT="failure"
          else
            RESULT="success"
          fi
          
          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "errors=0" >> $GITHUB_OUTPUT
          echo "warnings=0" >> $GITHUB_OUTPUT

      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-reports
          path: reports/
          retention-days: 7

      - name: Comment PR with report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const moduleCount = '${{ steps.find-modules.outputs.count }}' || '0';
            const exitCode = '${{ steps.validate.outputs.exit_code }}' || '0';
            const duration = '${{ steps.validate.outputs.duration }}' || '0';
            const scope = '${{ inputs.validation-scope }}';
            
            const totalMethods = '${{ steps.metrics.outputs.total_methods }}' || '1';
            const totalFields = '${{ steps.metrics.outputs.total_fields }}' || '1';
            const documentedMethods = '${{ steps.metrics.outputs.documented_methods }}' || '0';
            const fieldsWithString = '${{ steps.metrics.outputs.fields_with_string }}' || '0';
            const fieldsWithHelp = '${{ steps.metrics.outputs.fields_with_help }}' || '0';
            const docstringCov = '${{ steps.metrics.outputs.docstring_cov }}' || '0';
            const stringCov = '${{ steps.metrics.outputs.string_cov }}' || '0';
            const helpCov = '${{ steps.metrics.outputs.help_cov }}' || '0';
            
            const missingDocstringPr = '${{ steps.metrics.outputs.missing_docstring_pr }}' || '0';
            const missingStringPr = '${{ steps.metrics.outputs.missing_string_pr }}' || '0';
            const missingHelpPr = '${{ steps.metrics.outputs.missing_help_pr }}' || '0';
            
            const ruffChanged = '${{ steps.metrics.outputs.ruff_changed }}' || '0';
            const ruffFull = '${{ steps.metrics.outputs.ruff_full }}' || '0';
            const pylintChanged = '${{ steps.metrics.outputs.pylint_changed }}' || '0';
            const pylintFull = '${{ steps.metrics.outputs.pylint_full }}' || '0';
            
            function icon(val, threshold, reverse) {
              const v = parseInt(val) || 0;
              const t = parseInt(threshold) || 0;
              if (reverse) {
                return v <= t ? ':white_check_mark:' : ':x:';
              }
              return v >= t ? ':white_check_mark:' : ':warning:';
            }
            
            const overallStatus = parseInt(exitCode) === 0 ? ':white_check_mark: Passed' : ':x: Failed';
            
            const lines = [
              '## :bar_chart: Reporte de Validacion Solt',
              '',
              '> :information_source: Este analisis es **informativo**. El check bloqueante es "Odoo Module Validation".',
              '',
              '### :clipboard: Resumen',
              '',
              '| Metrica | Valor |',
              '|---------|-------|',
              '| **Estado general** | ' + overallStatus + ' |',
              '| Modulos analizados | ' + moduleCount + ' |',
              '| Scope | `' + scope + '` |',
              '| Tiempo | ' + duration + 's |',
              '',
              '### :books: Cobertura de Documentacion (Repositorio)',
              '',
              '| Metrica | Cobertura | Detalle | Meta | Estado |',
              '|---------|-----------|---------|------|--------|',
              '| Docstrings | **' + docstringCov + '%** | ' + documentedMethods + '/' + totalMethods + ' | >=80% | ' + icon(docstringCov, 80, false) + ' |',
              '| Campos con `string` | **' + stringCov + '%** | ' + fieldsWithString + '/' + totalFields + ' | >=90% | ' + icon(stringCov, 90, false) + ' |',
              '| Campos con `help` | **' + helpCov + '%** | ' + fieldsWithHelp + '/' + totalFields + ' | >=50% | ' + icon(helpCov, 50, false) + ' |',
              '',
              '### :warning: Issues en este PR',
              '',
              '| Tipo | Cantidad |',
              '|------|----------|',
              '| Docstrings faltantes | ' + missingDocstringPr + ' |',
              '| Campos sin `string` | ' + missingStringPr + ' |',
              '| Campos sin `help` | ' + missingHelpPr + ' |',
              '',
              '### :mag: Calidad de Codigo',
              '',
              '| Herramienta | Issues PR | Issues Repo | Meta | Estado |',
              '|-------------|-----------|-------------|------|--------|',
              '| :wrench: Ruff | ' + ruffChanged + ' | ' + ruffFull + ' | 0 | ' + icon(ruffFull, 0, true) + ' |',
              '| :snake: Pylint-Odoo | ' + pylintChanged + ' | ' + pylintFull + ' | 0 | ' + icon(pylintFull, 0, true) + ' |',
              '',
              '---',
              ':robot: *Generado por [solt-pre-commit](https://github.com/soltein-net/solt-pre-commit)*'
            ];
            
            const body = lines.join('\n');
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Reporte de Validacion Solt')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check result
        run: |
          RESULT="${{ steps.summary.outputs.result }}"
          RESULT="${RESULT:-success}"
          if [ "$RESULT" == "failure" ]; then
            echo "::error::Validation failed"
            exit 1
          fi

  # ---------------------------------------------------------------------------
  # PRE-COMMIT HOOKS
  # ---------------------------------------------------------------------------
  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }} --depth=1
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD 2>/dev/null | tr '\n' ' ' || echo "")
          fi
          
          VALID_FILES=""
          for f in $CHANGED_FILES; do
            [ -f "$f" ] && VALID_FILES="$VALID_FILES $f"
          done
          VALID_FILES=$(echo "$VALID_FILES" | xargs)
          
          FILE_COUNT=$(echo "$VALID_FILES" | wc -w | tr -d ' ')
          FILE_COUNT="${FILE_COUNT:-0}"
          
          echo "files=$VALID_FILES" >> $GITHUB_OUTPUT
          echo "count=$FILE_COUNT" >> $GITHUB_OUTPUT

      - name: Run pre-commit
        id: precommit
        run: |
          FILES="${{ steps.changed.outputs.files }}"
          COUNT="${{ steps.changed.outputs.count }}"
          COUNT="${COUNT:-0}"
          
          if [ -z "$FILES" ] || [ "$COUNT" == "0" ]; then
            echo "No files to check"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Checking $COUNT files..."
          if pre-commit run --files $FILES 2>&1 | tee precommit_output.txt; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Pre-commit Hooks" >> $GITHUB_STEP_SUMMARY
          echo "| Scope | Files |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Changed only | ${{ steps.changed.outputs.count }} |" >> $GITHUB_STEP_SUMMARY
          
          STATUS="${{ steps.precommit.outputs.status }}"
          STATUS="${STATUS:-unknown}"
          if [ "$STATUS" == "passed" ]; then
            echo "All hooks passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$STATUS" == "skipped" ]; then
            echo "No files to check" >> $GITHUB_STEP_SUMMARY
          else
            echo "Some hooks failed" >> $GITHUB_STEP_SUMMARY
          fi

  # ---------------------------------------------------------------------------
  # COVERAGE ANALYSIS (Optional)
  # ---------------------------------------------------------------------------
  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    if: inputs.run-coverage
    needs: validate

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Run coverage
        id: coverage
        continue-on-error: true
        run: |
          pip install coverage pytest pytest-cov
          mkdir -p reports
          COVERAGE=0
          
          if [ -d "tests" ]; then
            coverage run -m pytest tests/ -v --tb=short 2>&1 | tee reports/test_output.txt || true
            coverage report -m | tee reports/coverage.txt || true
            COVERAGE=$(tail -1 reports/coverage.txt 2>/dev/null | awk '{print $NF}' | tr -cd '0-9' || echo "0")
          fi
          
          COVERAGE="${COVERAGE:-0}"
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Check threshold
        run: |
          COV="${{ steps.coverage.outputs.percentage }}"
          THRESHOLD="${{ inputs.coverage-threshold }}"
          
          # Clean and default values
          COV=$(echo "$COV" | tr -cd '0-9')
          COV="${COV:-0}"
          THRESHOLD=$(echo "$THRESHOLD" | tr -cd '0-9')
          THRESHOLD="${THRESHOLD:-60}"
          
          echo "## Coverage: ${COV}%" >> $GITHUB_STEP_SUMMARY
          
          if [ "$COV" != "0" ] && [ "$COV" -lt "$THRESHOLD" ] 2>/dev/null; then
            echo "::error::Coverage ${COV}% < ${THRESHOLD}%"
            exit 1
          fi