# =============================================================================
# SOLT PRE-COMMIT - Reusable Workflow (Optimized)
# =============================================================================
# EXECUTION: Only on pull_request - validates CHANGED files only
# Badges are updated separately via weekly schedule
# =============================================================================
name: Soltein Validation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      fail-on-warnings:
        description: 'Fail if warnings are found'
        required: false
        type: boolean
        default: false
      ruff-blocking:
        description: 'Make Ruff issues blocking'
        required: false
        type: boolean
        default: false
      pylint-blocking:
        description: 'Make Pylint-Odoo issues blocking'
        required: false
        type: boolean
        default: true
    outputs:
      validation-result:
        value: ${{ jobs.validate.outputs.result }}
      errors-count:
        value: ${{ jobs.validate.outputs.errors }}
      warnings-count:
        value: ${{ jobs.validate.outputs.warnings }}

jobs:
  # ---------------------------------------------------------------------------
  # BRANCH VALIDATION
  # ---------------------------------------------------------------------------
  branch-check:
    name: Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      - run: pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"
      - name: Validate branch
        run: |
          if solt-check-branch "${{ github.head_ref }}"; then
            echo "✅ Branch name valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Branch name invalid" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ---------------------------------------------------------------------------
  # MAIN VALIDATION
  # ---------------------------------------------------------------------------
  validate:
    name: Soltein Odoo Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    outputs:
      result: ${{ steps.final-check.outputs.result }}
      errors: ${{ steps.summary.outputs.errors }}
      warnings: ${{ steps.summary.outputs.warnings }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0" pylint-odoo ruff

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }} --depth=1 || true

      - name: Get changed files
        id: changed
        run: |
          CHANGED_PY=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- '*.py' 2>/dev/null || true)
          CHANGED_ALL=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD 2>/dev/null | wc -l || echo 0)

          # Filter existing files
          EXISTING_PY=""
          for f in $CHANGED_PY; do [ -f "$f" ] && EXISTING_PY="$EXISTING_PY $f"; done
          EXISTING_PY=$(echo "$EXISTING_PY" | xargs)

          echo "py_files=$EXISTING_PY" >> $GITHUB_OUTPUT
          echo "py_count=$(echo "$EXISTING_PY" | wc -w | tr -d ' ')" >> $GITHUB_OUTPUT
          echo "total_count=$CHANGED_ALL" >> $GITHUB_OUTPUT

      - name: Find affected modules
        id: modules
        run: |
          MODULES=""
          for f in $(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD 2>/dev/null || true); do
            DIR=$(dirname "$f")
            while [ "$DIR" != "." ] && [ "$DIR" != "/" ]; do
              if [ -f "$DIR/__manifest__.py" ] || [ -f "$DIR/__openerp__.py" ]; then
                MODULES="$MODULES $DIR"
                break
              fi
              DIR=$(dirname "$DIR")
            done
          done
          MODULES=$(echo "$MODULES" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
          MODULE_COUNT=$(echo "$MODULES" | wc -w | tr -d ' ')

          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "count=$MODULE_COUNT" >> $GITHUB_OUTPUT
          echo "::notice::Modules: $MODULES (count: $MODULE_COUNT)"

      - name: Solt validation
        id: solt
        if: steps.modules.outputs.count != '0'
        continue-on-error: true
        env:
          SOLT_BASE_BRANCH: ${{ github.base_ref }}
        run: |
          mkdir -p reports
          START=$(date +%s)
          set +e
          solt-check-odoo ${{ steps.modules.outputs.modules }} --scope changed 2>&1 | tee reports/validation.txt
          CODE=$?
          set -e
          echo "exit_code=$CODE" >> $GITHUB_OUTPUT
          echo "duration=$(($(date +%s) - START))" >> $GITHUB_OUTPUT
          exit $CODE

      - name: Ruff linting
        id: ruff
        if: steps.changed.outputs.py_count != '0'
        continue-on-error: true
        run: |
          ISSUES=0
          if [ -n "${{ steps.changed.outputs.py_files }}" ]; then
            set +e
            ruff check ${{ steps.changed.outputs.py_files }} --output-format=concise > reports/ruff.txt 2>&1
            set -e
            ISSUES=$(grep -cE "^.+\.py:[0-9]+" reports/ruff.txt 2>/dev/null || echo 0)
          else
            echo "No Python files changed" > reports/ruff.txt
          fi
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT

      - name: Pylint-Odoo linting
        id: pylint
        if: steps.changed.outputs.py_count != '0'
        continue-on-error: true
        run: |
          ISSUES=0
          if [ -n "${{ steps.changed.outputs.py_files }}" ]; then
            set +e
            pylint --load-plugins=pylint_odoo --exit-zero ${{ steps.changed.outputs.py_files }} 2>&1 | \
              sed 's/\x1b\[[0-9;]*m//g' > reports/pylint.txt
            set -e
            ISSUES=$(grep -cE "\.py:[0-9]+:.*\[" reports/pylint.txt 2>/dev/null || echo 0)
          else
            echo "No Python files changed" > reports/pylint.txt
          fi
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT

      - name: Summary
        id: summary
        if: always()
        run: |
          ERRORS=0; WARNINGS=0
          if [ -f "reports/validation.txt" ]; then
            ERRORS=$(grep -oP "Errors:\s*\K\d+" reports/validation.txt 2>/dev/null | tail -1 || echo 0)
            WARNINGS=$(grep -oP "Warnings:\s*\K\d+" reports/validation.txt 2>/dev/null | tail -1 || echo 0)
          fi
          echo "errors=${ERRORS:-0}" >> $GITHUB_OUTPUT
          echo "warnings=${WARNINGS:-0}" >> $GITHUB_OUTPUT

      - name: Comment PR
        if: always()
        uses: actions/github-script@v7
        env:
          MODULE_COUNT: ${{ steps.modules.outputs.count }}
          CHANGED_FILES: ${{ steps.changed.outputs.total_count }}
          SOLT_EXIT: ${{ steps.solt.outputs.exit_code }}
          DURATION: ${{ steps.solt.outputs.duration }}
          ERRORS: ${{ steps.summary.outputs.errors }}
          WARNINGS: ${{ steps.summary.outputs.warnings }}
          RUFF_ISSUES: ${{ steps.ruff.outputs.issues }}
          PYLINT_ISSUES: ${{ steps.pylint.outputs.issues }}
          FAIL_ON_WARNINGS: ${{ inputs.fail-on-warnings }}
          RUFF_BLOCKING: ${{ inputs.ruff-blocking }}
          PYLINT_BLOCKING: ${{ inputs.pylint-blocking }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const fs = require('fs');
            const safeInt = (v, d = 0) => parseInt(v) || d;
            const prNumber = safeInt(process.env.PR_NUMBER);
            if (!prNumber) return;

            const errors = safeInt(process.env.ERRORS);
            const warnings = safeInt(process.env.WARNINGS);
            const ruff = safeInt(process.env.RUFF_ISSUES);
            const pylint = safeInt(process.env.PYLINT_ISSUES);
            const soltExit = safeInt(process.env.SOLT_EXIT);
            const failOnWarnings = process.env.FAIL_ON_WARNINGS === 'true';
            const ruffBlocking = process.env.RUFF_BLOCKING === 'true';
            const pylintBlocking = process.env.PYLINT_BLOCKING === 'true';

            const hasFailed = soltExit !== 0 || errors > 0 ||
              (failOnWarnings && warnings > 0) ||
              (ruffBlocking && ruff > 0) ||
              (pylintBlocking && failOnWarnings && pylint > 0);

            const status = hasFailed ? ':x: Failed' : ':white_check_mark: Passed';
            const msg = hasFailed ? '**Blocking issues found.**' : '**All checks passed.**';

            let body = `## :bar_chart: Validation Report\n\n> ${status} ${msg}\n\n`;
            body += `| Metric | Value |\n|--------|-------|\n`;
            body += `| Modules | ${process.env.MODULE_COUNT} |\n`;
            body += `| Files | ${process.env.CHANGED_FILES} |\n`;
            body += `| Time | ${process.env.DURATION}s |\n\n`;

            body += `| Tool | Issues | Mode |\n|------|--------|------|\n`;
            body += `| solt-check-odoo | ${errors} err / ${warnings} warn | blocking |\n`;
            body += `| Ruff | ${ruff} | ${ruffBlocking ? 'blocking' : 'info'} |\n`;
            body += `| Pylint-Odoo | ${pylint} | ${pylintBlocking ? 'blocking' : 'info'} |\n\n`;

            // Function to extract first 10 errors from a report file
            function extractErrors(filepath, pattern, limit = 10) {
              try {
                if (!fs.existsSync(filepath)) return [];
                const content = fs.readFileSync(filepath, 'utf8');
                const lines = content.split('\n');
                const errorLines = [];

                for (const line of lines) {
                  if (pattern.test(line) && errorLines.length < limit) {
                    errorLines.push(line.trim());
                  }
                }
                return errorLines;
              } catch (e) {
                return [];
              }
            }

            // Solt-check-odoo errors
            if (errors > 0 || warnings > 0) {
              const soltErrors = extractErrors('reports/validation.txt', /^\s*-\s+.+\.py:\d+|^\s*-\s+.+\.xml:\d+|^\s*-\s+.+\.csv:\d+/);
              if (soltErrors.length > 0) {
                body += `### :warning: Solt-check-odoo Issues (showing ${Math.min(soltErrors.length, 10)} of ${errors + warnings})\n\n`;
                body += `| # | Issue |\n|---|-------|\n`;
                soltErrors.forEach((err, idx) => {
                  const cleaned = err.replace(/^-\s*/, '').substring(0, 120);
                  body += `| ${idx + 1} | \`${cleaned}\` |\n`;
                });
                body += `\n`;
              }
            }

            // Ruff errors
            if (ruff > 0) {
              const ruffErrors = extractErrors('reports/ruff.txt', /\.py:\d+:\d+:/);
              if (ruffErrors.length > 0) {
                body += `### :warning: Ruff Issues (showing ${Math.min(ruffErrors.length, 10)} of ${ruff})\n\n`;
                body += `| # | Issue |\n|---|-------|\n`;
                ruffErrors.forEach((err, idx) => {
                  const cleaned = err.substring(0, 120);
                  body += `| ${idx + 1} | \`${cleaned}\` |\n`;
                });
                body += `\n`;
              }
            }

            // Pylint-Odoo errors
            if (pylint > 0) {
              const pylintErrors = extractErrors('reports/pylint.txt', /\.py:\d+:\d+:.*\[/);
              if (pylintErrors.length > 0) {
                body += `### :warning: Pylint-Odoo Issues (showing ${Math.min(pylintErrors.length, 10)} of ${pylint})\n\n`;
                body += `| # | Issue |\n|---|-------|\n`;
                pylintErrors.forEach((err, idx) => {
                  const cleaned = err.substring(0, 120);
                  body += `| ${idx + 1} | \`${cleaned}\` |\n`;
                });
                body += `\n`;
              }
            }

            body += `[:link: Full Logs](${process.env.WORKFLOW_URL})`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber,
            });
            const bot = comments.find(c => c.user.type === 'Bot' && c.body.includes('Validation Report'));

            if (bot) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: bot.id, body });
            } else {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body });
            }

      - name: Final check
        id: final-check
        if: always()
        env:
          SOLT_EXIT: ${{ steps.solt.outputs.exit_code }}
          ERRORS: ${{ steps.summary.outputs.errors }}
          WARNINGS: ${{ steps.summary.outputs.warnings }}
          RUFF: ${{ steps.ruff.outputs.issues }}
          PYLINT: ${{ steps.pylint.outputs.issues }}
        run: |
          FAILED=0
          [ "${SOLT_EXIT:-0}" != "0" ] && FAILED=1
          [ "${ERRORS:-0}" -gt 0 ] && FAILED=1
          [ "${{ inputs.fail-on-warnings }}" = "true" ] && [ "${WARNINGS:-0}" -gt 0 ] && FAILED=1
          [ "${{ inputs.ruff-blocking }}" = "true" ] && [ "${RUFF:-0}" -gt 0 ] && FAILED=1
          [ "${{ inputs.pylint-blocking }}" = "true" ] && [ "${{ inputs.fail-on-warnings }}" = "true" ] && [ "${PYLINT:-0}" -gt 0 ] && FAILED=1

          echo "result=$( [ $FAILED = 1 ] && echo failure || echo success )" >> $GITHUB_OUTPUT
          exit $FAILED
