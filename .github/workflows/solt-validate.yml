# =============================================================================
# SOLT PRE-COMMIT - Reusable Workflow (Multi-Version Odoo Support)
# =============================================================================
# IMPORTANT: This workflow will FAIL (red) when blocking issues are found.
#
# ODOO VERSION DETECTION:
# - Automatically detects Odoo version from branch name or manifest
# - Supports: 17.0, 18.0, 19.0+ (future versions)
# - Patterns: 17.0, 18.0, feature/17.0-*, 17.0-hotfix-*, etc.
#
# BADGE UPDATES:
# - Badge updates have been moved to solt-update-badges.yml
# - Configure that workflow to run weekly for documentation badges
# =============================================================================
name: Soltein Validation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version override (auto-detected if not set)'
        required: false
        type: string
        default: ''
      odoo-version:
        description: 'Odoo version override (auto-detected from branch if not set)'
        required: false
        type: string
        default: ''
      validation-scope:
        description: 'Validation scope: changed or full'
        required: false
        type: string
        default: 'changed'
      fail-on-warnings:
        description: 'Fail if warnings are found'
        required: false
        type: boolean
        default: false
      ruff-blocking:
        description: 'Make Ruff issues blocking (requires fail-on-warnings: true)'
        required: false
        type: boolean
        default: false
      pylint-blocking:
        description: 'Make Pylint-Odoo issues blocking (requires fail-on-warnings: true)'
        required: false
        type: boolean
        default: true
      show-info:
        description: 'Show info-level issues in report'
        required: false
        type: boolean
        default: false
    outputs:
      validation-result:
        description: 'Validation result (success/failure)'
        value: ${{ jobs.validate.outputs.result }}
      errors-count:
        description: 'Number of errors found'
        value: ${{ jobs.validate.outputs.errors }}
      warnings-count:
        description: 'Number of warnings found'
        value: ${{ jobs.validate.outputs.warnings }}
      detected-odoo-version:
        description: 'Detected Odoo version'
        value: ${{ jobs.validate.outputs.odoo_version }}
      detected-python-version:
        description: 'Detected Python version'
        value: ${{ jobs.validate.outputs.python_version }}

jobs:
  # ---------------------------------------------------------------------------
  # MAIN VALIDATION JOB - Includes version detection, branch check, and validation
  # ---------------------------------------------------------------------------
  validate:
    name: Soltein Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    outputs:
      result: ${{ steps.final-check.outputs.result }}
      errors: ${{ steps.summary.outputs.errors }}
      warnings: ${{ steps.summary.outputs.warnings }}
      odoo_version: ${{ steps.detect.outputs.odoo_version }}
      python_version: ${{ steps.detect.outputs.python_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------------------------------
      # STEP 1: Detect Odoo and Python versions
      # -------------------------------------------------------------------------
      - name: Detect versions
        id: detect
        run: |
          # Get branch name
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
            BASE_BRANCH="${{ github.base_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
            BASE_BRANCH=""
          fi

          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT

          # Check for input override
          INPUT_ODOO="${{ inputs.odoo-version }}"
          INPUT_PYTHON="${{ inputs.python-version }}"

          if [ -n "$INPUT_ODOO" ]; then
            ODOO_VERSION="$INPUT_ODOO"
            echo "::notice::Using input odoo-version: $ODOO_VERSION"
          else
            ODOO_VERSION=""

            # Pattern 1: Direct version branch (17.0, 18.0)
            if [[ "$BRANCH" =~ ^([0-9]+\.[0-9]+) ]]; then
              ODOO_VERSION="${BASH_REMATCH[1]}"
            fi

            # Pattern 2: Prefixed branch (feature/17.0-*, 17.0-hotfix-*)
            if [ -z "$ODOO_VERSION" ] && [[ "$BRANCH" =~ ([0-9]+\.[0-9]+) ]]; then
              ODOO_VERSION="${BASH_REMATCH[1]}"
            fi

            # Pattern 3: Check base branch for PRs
            if [ -z "$ODOO_VERSION" ] && [ -n "$BASE_BRANCH" ]; then
              if [[ "$BASE_BRANCH" =~ ^([0-9]+\.[0-9]+) ]]; then
                ODOO_VERSION="${BASH_REMATCH[1]}"
              fi
            fi

            # Pattern 4: Scan manifest files
            if [ -z "$ODOO_VERSION" ]; then
              MANIFEST_VERSION=$(find . -name "__manifest__.py" -exec grep -h '"version"' {} \; 2>/dev/null | head -1 | grep -oE '[0-9]+\.[0-9]+' | head -1 || echo "")
              if [ -n "$MANIFEST_VERSION" ]; then
                ODOO_VERSION="$MANIFEST_VERSION"
              fi
            fi

            # Default fallback
            if [ -z "$ODOO_VERSION" ]; then
              ODOO_VERSION="17.0"
              echo "::warning::Could not detect Odoo version, defaulting to $ODOO_VERSION"
            fi
          fi

          # Python version mapping
          if [ -n "$INPUT_PYTHON" ]; then
            PYTHON_VERSION="$INPUT_PYTHON"
          else
            case "$ODOO_VERSION" in
              16.0*) PYTHON_VERSION="3.10" ;;
              17.0*) PYTHON_VERSION="3.10" ;;
              18.0*) PYTHON_VERSION="3.11" ;;
              19.0*|20.0*|21.0*) PYTHON_VERSION="3.12" ;;
              *) PYTHON_VERSION="3.11" ;;
            esac
          fi

          echo "odoo_version=$ODOO_VERSION" >> $GITHUB_OUTPUT
          echo "python_version=$PYTHON_VERSION" >> $GITHUB_OUTPUT

          echo "::notice::Branch: $BRANCH | Odoo: $ODOO_VERSION | Python: $PYTHON_VERSION"

      # -------------------------------------------------------------------------
      # STEP 2: Setup Python
      # -------------------------------------------------------------------------
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.detect.outputs.python_version }}

      # -------------------------------------------------------------------------
      # STEP 3: Install dependencies
      # -------------------------------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.1" pylint-odoo ruff
          echo "::notice::Installed for Odoo ${{ steps.detect.outputs.odoo_version }}"

      # -------------------------------------------------------------------------
      # STEP 4: Validate branch name (PRs only)
      # -------------------------------------------------------------------------
      - name: Validate branch name
        if: github.event_name == 'pull_request'
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "## Branch Validation" >> $GITHUB_STEP_SUMMARY
          echo "Branch: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          if solt-check-branch "$BRANCH"; then
            echo "✅ Branch name is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Branch name is invalid" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      # -------------------------------------------------------------------------
      # STEP 5: Find Odoo modules
      # -------------------------------------------------------------------------
      - name: Find Odoo modules
        id: find-modules
        run: |
          MODULES=$(find . -name "__manifest__.py" -o -name "__openerp__.py" | xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          MODULE_COUNT=$(echo "$MODULES" | wc -w | tr -d ' ')
          : "${MODULE_COUNT:=0}"
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "count=$MODULE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $MODULE_COUNT modules"

      # -------------------------------------------------------------------------
      # STEP 6: Fetch base branch for PR diff
      # -------------------------------------------------------------------------
      - name: Fetch base branch
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }} --depth=1 || true

      # -------------------------------------------------------------------------
      # STEP 7: Soltein validation
      # -------------------------------------------------------------------------
      - name: Soltein validation
        id: validate
        continue-on-error: true
        env:
          SOLT_BASE_BRANCH: ${{ github.base_ref }}
          ODOO_VERSION: ${{ steps.detect.outputs.odoo_version }}
        run: |
          mkdir -p reports

          # Build arguments
          ARGS="--scope ${{ inputs.validation-scope }}"
          if [ "${{ inputs.show-info }}" = "true" ]; then
            ARGS="$ARGS --show-info"
          fi

          # Run validation
          set +e
          solt-check-odoo ${{ steps.find-modules.outputs.modules }} $ARGS --odoo-version "$ODOO_VERSION" 2>&1 | tee reports/validation.txt
          EXIT_CODE=$?
          set -e

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "::notice::Solt validation exit code: $EXIT_CODE"
          exit $EXIT_CODE

      # -------------------------------------------------------------------------
      # STEP 8: Ruff linting (changed files only)
      # -------------------------------------------------------------------------
      - name: Ruff linting
        id: ruff
        if: always()
        continue-on-error: true
        env:
          ODOO_VERSION: ${{ steps.detect.outputs.odoo_version }}
        run: |
          set +e
          mkdir -p reports

          echo "=== Ruff Linting (Odoo $ODOO_VERSION) ==="

          # Get changed Python files
          CHANGED_PY=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_PY=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ')
          else
            CHANGED_PY=$(git diff --name-only --diff-filter=ACMR HEAD~1...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ')
          fi

          RUFF_CHANGED=0
          if [ -n "$CHANGED_PY" ]; then
            EXISTING_PY=""
            for f in $CHANGED_PY; do
              [ -f "$f" ] && EXISTING_PY="$EXISTING_PY $f"
            done
            EXISTING_PY=$(echo "$EXISTING_PY" | xargs)

            if [ -n "$EXISTING_PY" ]; then
              FILE_COUNT=$(echo "$EXISTING_PY" | wc -w | tr -d ' ')
              echo "Checking $FILE_COUNT changed Python files..."
              ruff check $EXISTING_PY --output-format=concise 2>&1 | tee reports/ruff-changed.txt || true
              RUFF_CHANGED=$(grep -cE "^.+\.py:[0-9]+" reports/ruff-changed.txt 2>/dev/null || echo "0")
            fi
          fi

          : "${RUFF_CHANGED:=0}"
          echo "Ruff issues in changed files: $RUFF_CHANGED"
          echo "changed=$RUFF_CHANGED" >> $GITHUB_OUTPUT

      # -------------------------------------------------------------------------
      # STEP 9: Pylint-Odoo linting (changed files only)
      # -------------------------------------------------------------------------
      - name: Pylint-Odoo linting
        id: pylint
        if: always()
        continue-on-error: true
        env:
          ODOO_VERSION: ${{ steps.detect.outputs.odoo_version }}
        run: |
          set +e
          mkdir -p reports

          echo "=== Pylint-Odoo Linting (Odoo $ODOO_VERSION) ==="

          # Get changed Python files
          CHANGED_PY=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_PY=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ')
          else
            CHANGED_PY=$(git diff --name-only --diff-filter=ACMR HEAD~1...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ')
          fi

          PYLINT_CHANGED=0
          if [ -n "$CHANGED_PY" ]; then
            EXISTING_PY=""
            for f in $CHANGED_PY; do
              [ -f "$f" ] && EXISTING_PY="$EXISTING_PY $f"
            done
            EXISTING_PY=$(echo "$EXISTING_PY" | xargs)

            if [ -n "$EXISTING_PY" ]; then
              FILE_COUNT=$(echo "$EXISTING_PY" | wc -w | tr -d ' ')
              echo "Checking $FILE_COUNT changed Python files..."
              echo "$EXISTING_PY" | xargs pylint --load-plugins=pylint_odoo --exit-zero 2>&1 | tee reports/pylint-changed.txt || true
              PYLINT_CHANGED=$(grep -cE "\.py:[0-9]+:.*\[" reports/pylint-changed.txt 2>/dev/null || echo "0")
            fi
          fi

          : "${PYLINT_CHANGED:=0}"
          echo "Pylint issues in changed files: $PYLINT_CHANGED"
          echo "changed=$PYLINT_CHANGED" >> $GITHUB_OUTPUT

      # -------------------------------------------------------------------------
      # STEP 10: Extract summary
      # -------------------------------------------------------------------------
      - name: Extract summary
        id: summary
        if: always()
        run: |
          mkdir -p reports
          touch reports/validation.txt

          # Get exit code
          EXIT_CODE="${{ steps.validate.outputs.exit_code }}"
          EXIT_CODE=$(echo "$EXIT_CODE" | tr -cd '0-9')
          : "${EXIT_CODE:=0}"

          # Count errors/warnings from validation output
          ERRORS=0
          WARNINGS=0
          if [ -f "reports/validation.txt" ]; then
            ERRORS=$(grep -oP "Errors:\s*\K\d+" reports/validation.txt 2>/dev/null | tail -1 || echo "0")
            WARNINGS=$(grep -oP "Warnings:\s*\K\d+" reports/validation.txt 2>/dev/null | tail -1 || echo "0")
          fi
          ERRORS=$(echo "$ERRORS" | tr -cd '0-9')
          WARNINGS=$(echo "$WARNINGS" | tr -cd '0-9')
          : "${ERRORS:=0}"
          : "${WARNINGS:=0}"

          # Linter counts
          RUFF_CHANGED="${{ steps.ruff.outputs.changed }}"
          PYLINT_CHANGED="${{ steps.pylint.outputs.changed }}"
          RUFF_CHANGED=$(echo "$RUFF_CHANGED" | tr -cd '0-9')
          PYLINT_CHANGED=$(echo "$PYLINT_CHANGED" | tr -cd '0-9')
          : "${RUFF_CHANGED:=0}"
          : "${PYLINT_CHANGED:=0}"

          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "validation_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "ruff_changed=$RUFF_CHANGED" >> $GITHUB_OUTPUT
          echo "pylint_changed=$PYLINT_CHANGED" >> $GITHUB_OUTPUT

          echo "::notice::Summary - Errors: $ERRORS, Warnings: $WARNINGS, Ruff: $RUFF_CHANGED, Pylint: $PYLINT_CHANGED"

      # -------------------------------------------------------------------------
      # STEP 11: Comment PR with report
      # -------------------------------------------------------------------------
      - name: Comment PR with report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        env:
          MODULE_COUNT: ${{ steps.find-modules.outputs.count }}
          ERRORS_COUNT: ${{ steps.summary.outputs.errors }}
          WARNINGS_COUNT: ${{ steps.summary.outputs.warnings }}
          RUFF_CHANGED: ${{ steps.summary.outputs.ruff_changed }}
          PYLINT_CHANGED: ${{ steps.summary.outputs.pylint_changed }}
          FAIL_ON_WARNINGS: ${{ inputs.fail-on-warnings }}
          RUFF_BLOCKING: ${{ inputs.ruff-blocking }}
          PYLINT_BLOCKING: ${{ inputs.pylint-blocking }}
          ODOO_VERSION: ${{ steps.detect.outputs.odoo_version }}
        with:
          script: |
            function safeInt(val, def = 0) {
              const parsed = parseInt(val);
              return isNaN(parsed) ? def : parsed;
            }

            const prNumber = context.issue.number;
            if (!prNumber) {
              console.log('No PR number found, skipping comment');
              return;
            }

            const workflowUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            const moduleCount = safeInt(process.env.MODULE_COUNT);
            const errorsCount = safeInt(process.env.ERRORS_COUNT);
            const warningsCount = safeInt(process.env.WARNINGS_COUNT);
            const ruffChanged = safeInt(process.env.RUFF_CHANGED);
            const pylintChanged = safeInt(process.env.PYLINT_CHANGED);
            const failOnWarnings = process.env.FAIL_ON_WARNINGS === 'true';
            const ruffBlocking = process.env.RUFF_BLOCKING === 'true';
            const pylintBlocking = process.env.PYLINT_BLOCKING === 'true';
            const odooVersion = process.env.ODOO_VERSION || '17.0';

            // Determine status
            const hasErrors = errorsCount > 0;
            const hasBlockingWarnings = failOnWarnings && warningsCount > 0;
            const hasBlockingPylint = failOnWarnings && pylintBlocking && pylintChanged > 0;
            const hasBlockingRuff = failOnWarnings && ruffBlocking && ruffChanged > 0;
            const hasFailed = hasErrors || hasBlockingWarnings || hasBlockingPylint || hasBlockingRuff;

            const overallStatus = hasFailed ? ':x: Failed' : ':white_check_mark: Passed';

            const bodyParts = [];
            bodyParts.push(`## :bar_chart: Validation Report (Odoo ${odooVersion})`);
            bodyParts.push('');
            if (hasFailed) {
              bodyParts.push('> :no_entry: **This PR is blocked.** Fix the errors below before merging.');
            } else {
              bodyParts.push('> :white_check_mark: **All checks passed.** This PR is ready for review.');
            }
            bodyParts.push('');

            bodyParts.push('### :clipboard: Summary');
            bodyParts.push('');
            bodyParts.push('| Metric | Value |');
            bodyParts.push('|--------|-------|');
            bodyParts.push(`| Status | ${overallStatus} |`);
            bodyParts.push(`| Odoo Version | **${odooVersion}** |`);
            bodyParts.push(`| Modules | ${moduleCount} |`);
            bodyParts.push(`| Errors | ${errorsCount} |`);
            bodyParts.push(`| Warnings | ${warningsCount} |`);
            bodyParts.push(`| Ruff Issues | ${ruffChanged} |`);
            bodyParts.push(`| Pylint Issues | ${pylintChanged} |`);
            bodyParts.push('');

            bodyParts.push('---');
            bodyParts.push(`:link: **[View full workflow logs](${workflowUrl})**`);
            bodyParts.push('');
            bodyParts.push(`:robot: *solt-pre-commit v1.0.1 (Odoo ${odooVersion})*`);

            const body = bodyParts.join('\n');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Validation Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

      # -------------------------------------------------------------------------
      # STEP 12: Final validation check
      # -------------------------------------------------------------------------
      - name: Final validation check
        id: final-check
        if: always()
        env:
          ODOO_VERSION: ${{ steps.detect.outputs.odoo_version }}
        run: |
          EXIT_CODE="${{ steps.validate.outputs.exit_code }}"
          EXIT_CODE=$(echo "$EXIT_CODE" | tr -cd '0-9')
          : "${EXIT_CODE:=0}"

          WARNINGS="${{ steps.summary.outputs.warnings }}"
          WARNINGS=$(echo "$WARNINGS" | tr -cd '0-9')
          : "${WARNINGS:=0}"

          RUFF_CHANGED="${{ steps.summary.outputs.ruff_changed }}"
          RUFF_CHANGED=$(echo "$RUFF_CHANGED" | tr -cd '0-9')
          : "${RUFF_CHANGED:=0}"

          PYLINT_CHANGED="${{ steps.summary.outputs.pylint_changed }}"
          PYLINT_CHANGED=$(echo "$PYLINT_CHANGED" | tr -cd '0-9')
          : "${PYLINT_CHANGED:=0}"

          FAIL_ON_WARNINGS="${{ inputs.fail-on-warnings }}"
          RUFF_BLOCKING="${{ inputs.ruff-blocking }}"
          PYLINT_BLOCKING="${{ inputs.pylint-blocking }}"

          echo "::notice::Final check (Odoo $ODOO_VERSION) - Exit=$EXIT_CODE, Warnings=$WARNINGS, Pylint=$PYLINT_CHANGED (blocking=$PYLINT_BLOCKING), Ruff=$RUFF_CHANGED (blocking=$RUFF_BLOCKING)"

          # Determine final result
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Validation FAILED - solt-check-odoo blocking errors"
            exit 1
          elif [ "$FAIL_ON_WARNINGS" = "true" ] && [ "$WARNINGS" -gt 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Validation FAILED - warnings with fail-on-warnings enabled"
            exit 1
          elif [ "$FAIL_ON_WARNINGS" = "true" ] && [ "$PYLINT_BLOCKING" = "true" ] && [ "$PYLINT_CHANGED" -gt 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Validation FAILED - Pylint-Odoo issues (pylint-blocking enabled)"
            exit 1
          elif [ "$FAIL_ON_WARNINGS" = "true" ] && [ "$RUFF_BLOCKING" = "true" ] && [ "$RUFF_CHANGED" -gt 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Validation FAILED - Ruff issues (ruff-blocking enabled)"
            exit 1
          else
            echo "result=success" >> $GITHUB_OUTPUT
            echo "::notice::Validation PASSED (Odoo $ODOO_VERSION)"
            exit 0
          fi
