# =============================================================================
# SOLT PRE-COMMIT - Reusable Workflow (Simplified Single Job)
# =============================================================================
# Version: 1.0.1
# IMPORTANT: This workflow will FAIL (red) when blocking issues are found.
#
# FEATURES:
# - Tolerant to empty repositories (no modules = success)
# - Auto-detects Odoo version from branch name or manifest
# - Supports: 17.0, 18.0, 19.0+ (future versions)
# - Uses appropriate Python version per Odoo version
# - Clear error messages for invalid branch names
# =============================================================================
name: Soltein Validation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version override (auto-detected if not set)'
        required: false
        type: string
        default: ''
      odoo-version:
        description: 'Odoo version override (auto-detected from branch if not set)'
        required: false
        type: string
        default: ''
      validation-scope:
        description: 'Validation scope: changed or full'
        required: false
        type: string
        default: 'changed'
      fail-on-warnings:
        description: 'Fail if warnings are found'
        required: false
        type: boolean
        default: false
      ruff-blocking:
        description: 'Make Ruff issues blocking (requires fail-on-warnings: true)'
        required: false
        type: boolean
        default: false
      pylint-blocking:
        description: 'Make Pylint-Odoo issues blocking (requires fail-on-warnings: true)'
        required: false
        type: boolean
        default: true
      show-info:
        description: 'Show info-level issues in report'
        required: false
        type: boolean
        default: false
    outputs:
      validation-result:
        description: 'Validation result (success/failure)'
        value: ${{ jobs.Validate.outputs.result }}
      errors-count:
        description: 'Number of errors found'
        value: ${{ jobs.Validate.outputs.errors }}
      warnings-count:
        description: 'Number of warnings found'
        value: ${{ jobs.Validate.outputs.warnings }}
      detected-odoo-version:
        description: 'Detected Odoo version'
        value: ${{ jobs.Validate.outputs.odoo_version }}
      detected-python-version:
        description: 'Detected Python version'
        value: ${{ jobs.Validate.outputs.python_version }}

jobs:
  Validate:
    name: Soltein Odoo Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    outputs:
      result: ${{ steps.final-check.outputs.result }}
      errors: ${{ steps.summary.outputs.errors }}
      warnings: ${{ steps.summary.outputs.warnings }}
      odoo_version: ${{ steps.detect-version.outputs.odoo_version }}
      python_version: ${{ steps.detect-version.outputs.python_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect versions
        id: detect-version
        run: |
          EVENT_NAME="${{ github.event_name }}"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
            BASE_BRANCH="${{ github.base_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
            BASE_BRANCH=""
          fi

          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "::notice::Branch: $BRANCH"

          INPUT_ODOO="${{ inputs.odoo-version }}"
          INPUT_PYTHON="${{ inputs.python-version }}"

          if [ -n "$INPUT_ODOO" ]; then
            ODOO_VERSION="$INPUT_ODOO"
          else
            ODOO_VERSION=""
            if [[ "$BRANCH" =~ ^([0-9]+\.[0-9]+) ]]; then
              ODOO_VERSION="${BASH_REMATCH[1]}"
            fi
            if [ -z "$ODOO_VERSION" ] && [[ "$BRANCH" =~ ^[a-z]+/([0-9]+\.[0-9]+) ]]; then
              ODOO_VERSION="${BASH_REMATCH[1]}"
            fi
            if [ -z "$ODOO_VERSION" ] && [[ "$BRANCH" =~ ([0-9]+\.[0-9]+) ]]; then
              ODOO_VERSION="${BASH_REMATCH[1]}"
            fi
            if [ -z "$ODOO_VERSION" ] && [ -n "$BASE_BRANCH" ]; then
              if [[ "$BASE_BRANCH" =~ ^([0-9]+\.[0-9]+) ]]; then
                ODOO_VERSION="${BASH_REMATCH[1]}"
              fi
            fi
            if [ -z "$ODOO_VERSION" ]; then
              MANIFEST_VERSION=$(find . -name "__manifest__.py" -exec grep -h '"version"' {} \; 2>/dev/null | head -1 | grep -oE '[0-9]+\.[0-9]+' | head -1 || echo "")
              if [ -n "$MANIFEST_VERSION" ]; then
                ODOO_VERSION="$MANIFEST_VERSION"
              fi
            fi
            if [ -z "$ODOO_VERSION" ]; then
              ODOO_VERSION="17.0"
            fi
          fi

          if [ -n "$INPUT_PYTHON" ]; then
            PYTHON_VERSION="$INPUT_PYTHON"
          else
            case "$ODOO_VERSION" in
              16.0*|17.0*) PYTHON_VERSION="3.10" ;;
              18.0*) PYTHON_VERSION="3.11" ;;
              19.0*|20.0*|21.0*|22.0*|23.0*|24.0*|25.0*) PYTHON_VERSION="3.12" ;;
              *) PYTHON_VERSION="3.11" ;;
            esac
          fi

          echo "odoo_version=$ODOO_VERSION" >> $GITHUB_OUTPUT
          echo "python_version=$PYTHON_VERSION" >> $GITHUB_OUTPUT
          echo "::notice::Odoo: $ODOO_VERSION, Python: $PYTHON_VERSION"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.detect-version.outputs.python_version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.6" pylint-odoo ruff

      - name: Validate branch name
        id: branch-check
        if: github.event_name == 'pull_request'
        continue-on-error: true
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "## Branch Validation" >> $GITHUB_STEP_SUMMARY
          echo "Branch: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          if solt-check-branch "$BRANCH"; then
            echo "✅ Branch name is valid" >> $GITHUB_STEP_SUMMARY
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Branch name is invalid" >> $GITHUB_STEP_SUMMARY
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Find Odoo modules
        id: find-modules
        run: |
          MODULES=$(find . -name "__manifest__.py" -o -name "__openerp__.py" | xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          MODULE_COUNT=$(echo "$MODULES" | wc -w | tr -d ' ')
          case "$MODULE_COUNT" in ''|*[!0-9]*) MODULE_COUNT=0 ;; esac
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "count=$MODULE_COUNT" >> $GITHUB_OUTPUT
          echo "::notice::Found $MODULE_COUNT Odoo modules"

          # If no modules found, mark as empty repo
          if [ "$MODULE_COUNT" = "0" ]; then
            echo "::warning::No Odoo modules found in repository - skipping validation"
            echo "## ℹ️ No Odoo Modules Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This repository doesn't contain any Odoo modules yet." >> $GITHUB_STEP_SUMMARY
            echo "Validation will run once you add a module with \`__manifest__.py\`." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fetch base branch
        if: github.event_name == 'pull_request' && steps.find-modules.outputs.count != '0'
        run: |
          git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }} --depth=1 || true

      - name: Soltein validation
        id: validate
        if: steps.find-modules.outputs.count != '0'
        continue-on-error: true
        env:
          SOLT_BASE_BRANCH: ${{ github.base_ref }}
          ODOO_VERSION: ${{ steps.detect-version.outputs.odoo_version }}
        run: |
          mkdir -p reports
          EVENT_NAME="${{ github.event_name }}"
          if [ "$EVENT_NAME" = "push" ]; then
            ARGS="--scope full"
          else
            ARGS="--scope ${{ inputs.validation-scope }}"
          fi
          SHOW_INFO="${{ inputs.show-info }}"
          if [ "$SHOW_INFO" = "true" ]; then
            ARGS="$ARGS --show-info"
          fi
          START_TIME=$(date +%s)
          set -o pipefail
          set +e
          solt-check-odoo ${{ steps.find-modules.outputs.modules }} $ARGS --odoo-version "$ODOO_VERSION" 2>&1 | tee reports/validation.txt
          VALIDATION_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          set +o pipefail
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "exit_code=$VALIDATION_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          exit $VALIDATION_EXIT_CODE

      - name: Ruff linting
        id: ruff
        if: always() && steps.find-modules.outputs.count != '0'
        continue-on-error: true
        env:
          ODOO_VERSION: ${{ steps.detect-version.outputs.odoo_version }}
        run: |
          set +e
          mkdir -p reports
          echo "=== Ruff Linting (Odoo $ODOO_VERSION) ==="
          CHANGED_PY=""
          EVENT_NAME="${{ github.event_name }}"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }} --depth=1 2>/dev/null || true
            CHANGED_PY=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ')
          else
            CHANGED_PY=$(git diff --name-only --diff-filter=ACMR HEAD~1...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ')
          fi
          RUFF_COUNT=0
          if [ -n "$CHANGED_PY" ]; then
            EXISTING_PY=""
            for f in $CHANGED_PY; do
              if [ -f "$f" ]; then
                EXISTING_PY="$EXISTING_PY $f"
              fi
            done
            EXISTING_PY=$(echo "$EXISTING_PY" | xargs)
            if [ -n "$EXISTING_PY" ]; then
              FILE_COUNT=$(echo "$EXISTING_PY" | wc -w | tr -d ' ')
              echo "Checking $FILE_COUNT changed Python files..."
              ruff check $EXISTING_PY --output-format=concise 2>&1 | tee reports/ruff-changed.txt || true
              RUFF_COUNT=$(grep -cE "^.+\.py:[0-9]+" reports/ruff-changed.txt 2>/dev/null || echo "0")
              case "$RUFF_COUNT" in ''|*[!0-9]*) RUFF_COUNT=0 ;; esac
            else
              echo "No existing Python files to check"
            fi
          else
            echo "No changed Python files detected"
          fi
          echo "Ruff issues in changed files: $RUFF_COUNT"
          echo "changed=$RUFF_COUNT" >> $GITHUB_OUTPUT

      - name: Pylint-Odoo linting
        id: pylint
        if: always() && steps.find-modules.outputs.count != '0'
        continue-on-error: true
        env:
          ODOO_VERSION: ${{ steps.detect-version.outputs.odoo_version }}
        run: |
          set +e
          mkdir -p reports
          echo "=== Pylint-Odoo Linting (Odoo $ODOO_VERSION) ==="
          strip_ansi() {
            sed 's/\x1b\[[0-9;]*m//g' | sed 's/\[0m//g' | sed 's/\[1;[0-9]*m//g' | sed 's/\[35m//g'
          }
          PYLINT_ARGS="--load-plugins=pylint_odoo --exit-zero"
          case "$ODOO_VERSION" in
            16.0*) PYLINT_ARGS="$PYLINT_ARGS --valid-odoo-versions=16.0" ;;
            17.0*) PYLINT_ARGS="$PYLINT_ARGS --valid-odoo-versions=17.0" ;;
            18.0*) PYLINT_ARGS="$PYLINT_ARGS --valid-odoo-versions=18.0" ;;
          esac
          CHANGED_PY=""
          EVENT_NAME="${{ github.event_name }}"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            CHANGED_PY=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ')
          else
            CHANGED_PY=$(git diff --name-only --diff-filter=ACMR HEAD~1...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ')
          fi
          PYLINT_COUNT=0
          if [ -n "$CHANGED_PY" ]; then
            EXISTING_PY=""
            for f in $CHANGED_PY; do
              if [ -f "$f" ]; then
                EXISTING_PY="$EXISTING_PY $f"
              fi
            done
            EXISTING_PY=$(echo "$EXISTING_PY" | xargs)
            if [ -n "$EXISTING_PY" ]; then
              FILE_COUNT=$(echo "$EXISTING_PY" | wc -w | tr -d ' ')
              echo "Checking $FILE_COUNT changed Python files..."
              echo "$EXISTING_PY" | xargs pylint $PYLINT_ARGS 2>&1 | strip_ansi | tee reports/pylint-changed.txt || true
              PYLINT_COUNT=$(grep -cE "\.py:[0-9]+:.*\[" reports/pylint-changed.txt 2>/dev/null || echo "0")
              case "$PYLINT_COUNT" in ''|*[!0-9]*) PYLINT_COUNT=0 ;; esac
            else
              echo "No existing Python files to check"
            fi
          else
            echo "No changed Python files detected"
          fi
          echo "Pylint issues in changed files: $PYLINT_COUNT"
          echo "changed=$PYLINT_COUNT" >> $GITHUB_OUTPUT

      - name: Extract summary
        id: summary
        if: always()
        run: |
          mkdir -p reports
          touch reports/validation.txt

          # Check if this is an empty repo (no modules)
          MODULE_COUNT="${{ steps.find-modules.outputs.count }}"
          if [ "$MODULE_COUNT" = "0" ]; then
            echo "errors=0" >> $GITHUB_OUTPUT
            echo "warnings=0" >> $GITHUB_OUTPUT
            echo "validation_exit_code=0" >> $GITHUB_OUTPUT
            echo "ruff_changed=0" >> $GITHUB_OUTPUT
            echo "pylint_changed=0" >> $GITHUB_OUTPUT
            echo "missing_docstring=0" >> $GITHUB_OUTPUT
            echo "missing_string=0" >> $GITHUB_OUTPUT
            echo "missing_help=0" >> $GITHUB_OUTPUT
            echo "is_empty_repo=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "is_empty_repo=false" >> $GITHUB_OUTPUT

          EXIT_CODE="${{ steps.validate.outputs.exit_code }}"
          case "$EXIT_CODE" in ''|*[!0-9]*) EXIT_CODE=0 ;; esac
          ERRORS=0
          WARNINGS=0
          if [ -f "reports/validation.txt" ]; then
            ERRORS=$(grep -oP "Errors:\s*\K\d+" reports/validation.txt 2>/dev/null | tail -1 || echo "0")
            WARNINGS=$(grep -oP "Warnings:\s*\K\d+" reports/validation.txt 2>/dev/null | tail -1 || echo "0")
          fi
          case "$ERRORS" in ''|*[!0-9]*) ERRORS=0 ;; esac
          case "$WARNINGS" in ''|*[!0-9]*) WARNINGS=0 ;; esac
          RUFF_COUNT="${{ steps.ruff.outputs.changed }}"
          case "$RUFF_COUNT" in ''|*[!0-9]*) RUFF_COUNT=0 ;; esac
          PYLINT_COUNT="${{ steps.pylint.outputs.changed }}"
          case "$PYLINT_COUNT" in ''|*[!0-9]*) PYLINT_COUNT=0 ;; esac
          MISSING_DOCSTRING=0
          MISSING_STRING=0
          MISSING_HELP=0
          if [ -f "reports/validation.txt" ]; then
            MISSING_DOCSTRING=$(grep -ci "missing docstring" reports/validation.txt 2>/dev/null || echo "0")
            MISSING_STRING=$(grep -ci "missing string" reports/validation.txt 2>/dev/null || echo "0")
            MISSING_HELP=$(grep -ci "missing help" reports/validation.txt 2>/dev/null || echo "0")
          fi
          case "$MISSING_DOCSTRING" in ''|*[!0-9]*) MISSING_DOCSTRING=0 ;; esac
          case "$MISSING_STRING" in ''|*[!0-9]*) MISSING_STRING=0 ;; esac
          case "$MISSING_HELP" in ''|*[!0-9]*) MISSING_HELP=0 ;; esac
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "validation_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "ruff_changed=$RUFF_COUNT" >> $GITHUB_OUTPUT
          echo "pylint_changed=$PYLINT_COUNT" >> $GITHUB_OUTPUT
          echo "missing_docstring=$MISSING_DOCSTRING" >> $GITHUB_OUTPUT
          echo "missing_string=$MISSING_STRING" >> $GITHUB_OUTPUT
          echo "missing_help=$MISSING_HELP" >> $GITHUB_OUTPUT

      - name: Extract issues for PR comment
        id: extract-issues
        if: always() && steps.find-modules.outputs.count != '0'
        run: |
          python3 << 'PYEOF'
          import os, re, json
          MAX_ERRORS = 10
          result = {'errors': [], 'warnings': [], 'total_errors': 0, 'total_warnings': 0, 'pylint_errors': [], 'pylint_errors_count': 0, 'ruff_errors': [], 'ruff_errors_count': 0}
          def strip_ansi(text):
              return re.compile(r'\x1b\[[0-9;]*m|\[0m|\[1;[0-9]*m|\[35m').sub('', text)
          def escape_html(text):
              return strip_ansi(text).replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;')
          def shorten_path(filepath):
              parts = filepath.replace('\\', '/').split('/')
              return '/'.join(parts[-2:]) if len(parts) > 2 else filepath
          try:
              with open('reports/validation.txt', 'r', encoding='utf-8', errors='replace') as f:
                  content = f.read()
              errors_match = re.search(r'Errors:\s*(\d+)', content)
              warnings_match = re.search(r'Warnings:\s*(\d+)', content)
              if errors_match: result['total_errors'] = int(errors_match.group(1))
              if warnings_match: result['total_warnings'] = int(warnings_match.group(1))
              current_severity = None
              for line in content.split('\n'):
                  line_stripped = line.strip()
                  if 'ERRORS' in line_stripped.upper() and '(' in line_stripped: current_severity = 'error'
                  elif 'WARNING' in line_stripped.upper() and '(' in line_stripped: current_severity = 'warning'
                  elif 'INFO' in line_stripped.upper() and '(' in line_stripped: current_severity = 'info'
                  if line.startswith('    - ') and current_severity in ('error', 'warning'):
                      msg_content = line[6:]
                      file_match = re.match(r'^([^\s:]+):(\d+)\s+(.+)$', msg_content)
                      entry = {'file': shorten_path(file_match.group(1)), 'line': file_match.group(2), 'message': escape_html(file_match.group(3)[:120])} if file_match else {'file': '', 'line': '', 'message': escape_html(msg_content[:150])}
                      if current_severity == 'error' and len(result['errors']) < MAX_ERRORS: result['errors'].append(entry)
                      elif current_severity == 'warning' and len(result['warnings']) < MAX_ERRORS: result['warnings'].append(entry)
          except FileNotFoundError: pass
          try:
              with open('reports/pylint-changed.txt', 'r', encoding='utf-8', errors='replace') as f:
                  for line in f.read().split('\n'):
                      match = re.match(r'^(.+?\.py):(\d+):\s*(?:\d+:\s*)?\[([A-Z]\d+)\(([^)]+)\),\s*([^\]]*)\]\s*(.+)$', line.strip())
                      if match:
                          result['pylint_errors'].append({'file': shorten_path(match.group(1)), 'line': match.group(2), 'message': escape_html(f"[{match.group(3)}] {match.group(6)}"[:120]), 'code': match.group(3)})
              result['pylint_errors_count'] = len(result['pylint_errors'])
          except FileNotFoundError: pass
          try:
              with open('reports/ruff-changed.txt', 'r', encoding='utf-8', errors='replace') as f:
                  for line in f.read().split('\n'):
                      match = re.match(r'^(.+?\.py):(\d+):(\d+):\s*([A-Z]+\d+)\s+(.+)$', line.strip())
                      if match:
                          filepath = re.sub(r'/home/runner/work/[^/]+/', '', shorten_path(match.group(1)))
                          result['ruff_errors'].append({'file': filepath, 'line': match.group(2), 'message': escape_html(f"[{match.group(4)}] {match.group(5)[:100]}"), 'code': match.group(4)})
              result['ruff_errors_count'] = len(result['ruff_errors'])
          except FileNotFoundError: pass
          with open('reports/extracted_issues.json', 'w') as f: json.dump(result, f, indent=2)
          print(f"Extracted: {len(result['errors'])} errors, {len(result['warnings'])} warnings, {result['pylint_errors_count']} pylint, {result['ruff_errors_count']} ruff")
          PYEOF

      - name: Comment PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        env:
          MODULE_COUNT: ${{ steps.find-modules.outputs.count }}
          EXIT_CODE: ${{ steps.validate.outputs.exit_code }}
          DURATION: ${{ steps.validate.outputs.duration }}
          SCOPE: ${{ inputs.validation-scope }}
          ERRORS_COUNT: ${{ steps.summary.outputs.errors }}
          WARNINGS_COUNT: ${{ steps.summary.outputs.warnings }}
          MISSING_DOCSTRING: ${{ steps.summary.outputs.missing_docstring }}
          MISSING_STRING: ${{ steps.summary.outputs.missing_string }}
          MISSING_HELP: ${{ steps.summary.outputs.missing_help }}
          RUFF_CHANGED: ${{ steps.ruff.outputs.changed }}
          PYLINT_CHANGED: ${{ steps.pylint.outputs.changed }}
          FAIL_ON_WARNINGS: ${{ inputs.fail-on-warnings }}
          RUFF_BLOCKING: ${{ inputs.ruff-blocking }}
          PYLINT_BLOCKING: ${{ inputs.pylint-blocking }}
          ODOO_VERSION: ${{ steps.detect-version.outputs.odoo_version }}
          PYTHON_VERSION: ${{ steps.detect-version.outputs.python_version }}
          IS_EMPTY_REPO: ${{ steps.summary.outputs.is_empty_repo }}
          BRANCH_VALID: ${{ steps.branch-check.outputs.valid }}
          BRANCH_NAME: ${{ steps.branch-check.outputs.branch_name }}
        with:
          script: |
            const fs = require('fs');
            const safeInt = (val, def = 0) => { const p = parseInt(val); return isNaN(p) ? def : p; };
            const prNumber = context.issue.number;
            if (!prNumber) return;

            const serverUrl = process.env.GITHUB_SERVER_URL || 'https://github.com';
            const repository = process.env.GITHUB_REPOSITORY || '';
            const runId = process.env.GITHUB_RUN_ID || '';
            const workflowUrl = `${serverUrl}/${repository}/actions/runs/${runId}`;
            const moduleCount = safeInt(process.env.MODULE_COUNT);
            const odooVersion = process.env.ODOO_VERSION || '17.0';
            const pythonVersion = process.env.PYTHON_VERSION || '3.11';
            const isEmptyRepo = process.env.IS_EMPTY_REPO === 'true';
            const branchValid = process.env.BRANCH_VALID !== 'false';
            const branchName = process.env.BRANCH_NAME || '';

            const bodyParts = [];

            // Handle invalid branch name case
            if (!branchValid) {
              bodyParts.push(`## :x: Validation Failed (Odoo ${odooVersion})`);
              bodyParts.push('');
              bodyParts.push('> :no_entry: **Invalid branch name.** Please rename your branch to continue.');
              bodyParts.push('');
              bodyParts.push(`**Branch:** \`${branchName}\``);
              bodyParts.push('');
              bodyParts.push('### :label: Branch Naming Convention');
              bodyParts.push('');
              bodyParts.push('Branch names must follow one of these patterns:');
              bodyParts.push('- `<type>/<odoo-version>-<description>` (e.g., `feature/17.0-add-invoice`)');
              bodyParts.push('- `<type>/<odoo-version>-<TICKET>-<number>-<description>` (e.g., `fix/17.0-SOLT-123-bug-fix`)');
              bodyParts.push('');
              bodyParts.push('**Valid types:** `feature`, `fix`, `hotfix`, `bugfix`, `release`, `refactor`, `docs`, `test`, `chore`');
              bodyParts.push('');
              bodyParts.push(':warning: **Note:** Use hyphens (`-`) as separators, not underscores (`_`).');
              bodyParts.push('');
              bodyParts.push('**Examples:**');
              bodyParts.push('| Branch | Status |');
              bodyParts.push('|--------|--------|');
              bodyParts.push('| `feature/17.0-add-new-feature` | :white_check_mark: Valid |');
              bodyParts.push('| `fix/17.0-SOLT-123-bug-fix` | :white_check_mark: Valid |');
              bodyParts.push('| `17.0-feature-something` | :white_check_mark: Valid |');
              bodyParts.push('| `feature/17.0_add_feature` | :x: Invalid (uses `_`) |');
              bodyParts.push(`| \`${branchName}\` | :x: Invalid |`);
              bodyParts.push('');
              bodyParts.push('---');
              bodyParts.push(`:link: **[View workflow logs](${workflowUrl})**`);
              bodyParts.push('');
              bodyParts.push(`:robot: *solt-pre-commit v1.0.6 (Odoo ${odooVersion})*`);
            }
            // Handle empty repository case
            else if (isEmptyRepo || moduleCount === 0) {
              bodyParts.push(`## :white_check_mark: Validation Report (Odoo ${odooVersion})`);
              bodyParts.push('');
              bodyParts.push('> :information_source: **No Odoo modules found in this repository.**');
              bodyParts.push('');
              bodyParts.push('This PR only contains configuration files. Validation will run once you add an Odoo module with `__manifest__.py`.');
              bodyParts.push('');
              bodyParts.push('---');
              bodyParts.push(`:robot: *solt-pre-commit v1.0.6 (Odoo ${odooVersion})*`);
            } else {
              // Normal validation report
              const exitCode = safeInt(process.env.EXIT_CODE);
              const duration = safeInt(process.env.DURATION);
              const scope = process.env.SCOPE || 'changed';
              const errorsCount = safeInt(process.env.ERRORS_COUNT);
              const warningsCount = safeInt(process.env.WARNINGS_COUNT);
              const failOnWarnings = process.env.FAIL_ON_WARNINGS === 'true';
              const ruffBlocking = process.env.RUFF_BLOCKING === 'true';
              const pylintBlocking = process.env.PYLINT_BLOCKING === 'true';
              const missingDocstring = safeInt(process.env.MISSING_DOCSTRING);
              const missingString = safeInt(process.env.MISSING_STRING);
              const missingHelp = safeInt(process.env.MISSING_HELP);
              const ruffChanged = safeInt(process.env.RUFF_CHANGED);
              const pylintChanged = safeInt(process.env.PYLINT_CHANGED);

              let extractedIssues = {errors: [], warnings: [], total_errors: 0, total_warnings: 0, pylint_errors: [], pylint_errors_count: 0, ruff_errors: [], ruff_errors_count: 0};
              try { extractedIssues = JSON.parse(fs.readFileSync('reports/extracted_issues.json', 'utf8')); } catch (e) {}

              const totalErrors = extractedIssues.total_errors || errorsCount;
              const totalWarnings = extractedIssues.total_warnings || warningsCount;
              const icon = (val, th, rev = false) => rev ? (val <= th ? ':white_check_mark:' : ':x:') : (val >= th ? ':white_check_mark:' : ':warning:');
              const hasBlockingErrors = exitCode !== 0;
              const hasWarnings = warningsCount > 0 || (pylintBlocking && pylintChanged > 0) || (ruffBlocking && ruffChanged > 0);
              const hasFailed = hasBlockingErrors || (failOnWarnings && hasWarnings);
              const overallStatus = hasFailed ? ':x: Failed' : ':white_check_mark: Passed';
              const MAX_DISPLAY = 10;

              bodyParts.push(`## :bar_chart: Validation Report (Odoo ${odooVersion})`);
              bodyParts.push('');
              bodyParts.push(hasFailed ? '> :no_entry: **This PR is blocked.** Fix the errors below before merging.' : '> :white_check_mark: **All checks passed.** This PR is ready for review.');
              bodyParts.push('');
              bodyParts.push('### :clipboard: Summary');
              bodyParts.push('');
              bodyParts.push('| Metric | Value |');
              bodyParts.push('|--------|-------|');
              bodyParts.push(`| Status | ${overallStatus} |`);
              bodyParts.push(`| Odoo Version | **${odooVersion}** |`);
              bodyParts.push(`| Python Version | ${pythonVersion} |`);
              bodyParts.push(`| Modules | ${moduleCount} |`);
              bodyParts.push(`| Scope | \`${scope}\` |`);
              bodyParts.push(`| Time | ${duration}s |`);
              bodyParts.push('');

              const totalDocIssues = missingDocstring + missingString + missingHelp;
              if (totalDocIssues > 0) {
                bodyParts.push('### :books: Documentation Issues in this PR');
                bodyParts.push('');
                bodyParts.push('| Type | Count |');
                bodyParts.push('|------|-------|');
                if (missingDocstring > 0) bodyParts.push(`| Missing docstrings | ${missingDocstring} |`);
                if (missingString > 0) bodyParts.push(`| Fields without string | ${missingString} |`);
                if (missingHelp > 0) bodyParts.push(`| Fields without help | ${missingHelp} |`);
                bodyParts.push('');
              }

              const ruffMode = ruffBlocking ? 'blocking' : 'info';
              const pylintMode = pylintBlocking ? 'blocking' : 'info';
              bodyParts.push('### :mag: Code Quality (Changed Files)');
              bodyParts.push('');
              bodyParts.push('| Tool | Issues | Mode | Status |');
              bodyParts.push('|------|--------|------|--------|');
              bodyParts.push(`| Ruff | ${ruffChanged} | ${ruffMode} | ${icon(ruffChanged, 0, true)} |`);
              bodyParts.push(`| Pylint-Odoo | ${pylintChanged} | ${pylintMode} | ${icon(pylintChanged, 0, true)} |`);
              bodyParts.push('');

              const soltErrors = extractedIssues.errors || [];
              const soltWarnings = extractedIssues.warnings || [];
              const pylintErrors = extractedIssues.pylint_errors || [];
              const ruffErrors = extractedIssues.ruff_errors || [];
              const showPagination = (total, type) => total > MAX_DISPLAY ? `> Showing ${MAX_DISPLAY} of ${total} ${type}. **[View all in workflow logs](${workflowUrl})**` : (total > 0 ? `> **[View details in workflow logs](${workflowUrl})**` : '');

              if (totalErrors > 0 && soltErrors.length > 0) {
                bodyParts.push(`### :no_entry: Solt Check Errors (${totalErrors})`);
                bodyParts.push('');
                bodyParts.push('| File | Line | Error |');
                bodyParts.push('|------|------|-------|');
                for (const err of soltErrors.slice(0, MAX_DISPLAY)) bodyParts.push(`| \`${err.file || '-'}\` | ${err.line || '-'} | ${err.message || 'Unknown'} |`);
                bodyParts.push('');
                bodyParts.push(showPagination(totalErrors, 'errors'));
                bodyParts.push('');
              }

              if (failOnWarnings && totalWarnings > 0 && soltWarnings.length > 0) {
                bodyParts.push(`### :warning: Solt Check Warnings (${totalWarnings})`);
                bodyParts.push('');
                bodyParts.push('> **Note:** \`fail-on-warnings\` is enabled.');
                bodyParts.push('');
                bodyParts.push('| File | Line | Warning |');
                bodyParts.push('|------|------|---------|');
                for (const warn of soltWarnings.slice(0, MAX_DISPLAY)) bodyParts.push(`| \`${warn.file || '-'}\` | ${warn.line || '-'} | ${warn.message || 'Unknown'} |`);
                bodyParts.push('');
                bodyParts.push(showPagination(totalWarnings, 'warnings'));
                bodyParts.push('');
              }

              if (pylintChanged > 0) {
                const isBlocking = pylintBlocking && failOnWarnings;
                bodyParts.push(`### ${isBlocking ? ':no_entry:' : ':information_source:'} Pylint-Odoo Issues (${isBlocking ? 'blocking' : 'info'})`);
                bodyParts.push('');
                if (pylintErrors.length > 0) {
                  bodyParts.push('| File | Line | Issue |');
                  bodyParts.push('|------|------|-------|');
                  for (const err of pylintErrors.slice(0, MAX_DISPLAY)) bodyParts.push(`| \`${err.file || '-'}\` | ${err.line || '-'} | ${err.message || 'Unknown'} |`);
                  bodyParts.push('');
                  bodyParts.push(showPagination(pylintChanged, 'issues'));
                } else {
                  bodyParts.push(`> ${pylintChanged} issues found. **[View details in workflow logs](${workflowUrl})**`);
                }
                bodyParts.push('');
              }

              if (ruffChanged > 0) {
                const isBlocking = ruffBlocking && failOnWarnings;
                bodyParts.push(`### ${isBlocking ? ':no_entry:' : ':information_source:'} Ruff Issues (${isBlocking ? 'blocking' : 'info'})`);
                bodyParts.push('');
                if (ruffErrors.length > 0) {
                  bodyParts.push('| File | Line | Issue |');
                  bodyParts.push('|------|------|-------|');
                  for (const err of ruffErrors.slice(0, MAX_DISPLAY)) bodyParts.push(`| \`${err.file || '-'}\` | ${err.line || '-'} | ${err.message || 'Unknown'} |`);
                  bodyParts.push('');
                  bodyParts.push(showPagination(ruffChanged, 'issues'));
                } else {
                  bodyParts.push(`> ${ruffChanged} issues found. **[View details in workflow logs](${workflowUrl})**`);
                }
                bodyParts.push('');
              }

              bodyParts.push('---');
              if (hasFailed) bodyParts.push(':bulb: **Tip:** Fix the blocking issues above and push again.\n');
              bodyParts.push(`:link: **[View full workflow logs](${workflowUrl})**`);
              bodyParts.push('');
              bodyParts.push(`:robot: *solt-pre-commit v1.0.6 (Odoo ${odooVersion})*`);
            }

            const body = bodyParts.join('\n');
            const { data: comments } = await github.rest.issues.listComments({owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber});
            const botComment = comments.find(c => c.user.type === 'Bot' && (c.body.includes('Validation Report') || c.body.includes('Validation Failed') || c.body.includes('Validation Passed')));
            if (botComment) {
              await github.rest.issues.updateComment({owner: context.repo.owner, repo: context.repo.repo, comment_id: botComment.id, body: body});
            } else {
              await github.rest.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body: body});
            }

      - name: Final validation check
        id: final-check
        if: always()
        env:
          ODOO_VERSION: ${{ steps.detect-version.outputs.odoo_version }}
          MODULE_COUNT: ${{ steps.find-modules.outputs.count }}
          BRANCH_VALID: ${{ steps.branch-check.outputs.valid }}
        run: |
          # Check branch validation first (for PRs)
          if [ "$BRANCH_VALID" = "false" ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Validation FAILED - invalid branch name"
            exit 1
          fi

          # If no modules, always pass
          if [ "$MODULE_COUNT" = "0" ]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "::notice::No Odoo modules found - validation skipped (success)"
            exit 0
          fi

          EXIT_CODE="${{ steps.validate.outputs.exit_code }}"
          case "$EXIT_CODE" in ''|*[!0-9]*) EXIT_CODE=0 ;; esac
          FAIL_ON_WARNINGS="${{ inputs.fail-on-warnings }}"
          RUFF_BLOCKING="${{ inputs.ruff-blocking }}"
          PYLINT_BLOCKING="${{ inputs.pylint-blocking }}"
          WARNINGS="${{ steps.summary.outputs.warnings }}"
          case "$WARNINGS" in ''|*[!0-9]*) WARNINGS=0 ;; esac
          RUFF_CHANGED="${{ steps.summary.outputs.ruff_changed }}"
          case "$RUFF_CHANGED" in ''|*[!0-9]*) RUFF_CHANGED=0 ;; esac
          PYLINT_CHANGED="${{ steps.summary.outputs.pylint_changed }}"
          case "$PYLINT_CHANGED" in ''|*[!0-9]*) PYLINT_CHANGED=0 ;; esac
          echo "::notice::Final check (Odoo $ODOO_VERSION) - Exit=$EXIT_CODE, Warnings=$WARNINGS, Pylint=$PYLINT_CHANGED (blocking=$PYLINT_BLOCKING), Ruff=$RUFF_CHANGED (blocking=$RUFF_BLOCKING)"
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Validation FAILED - solt-check-odoo blocking errors"
            exit 1
          elif [ "$FAIL_ON_WARNINGS" = "true" ] && [ "$WARNINGS" -gt 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Validation FAILED - warnings with fail-on-warnings enabled"
            exit 1
          elif [ "$FAIL_ON_WARNINGS" = "true" ] && [ "$PYLINT_BLOCKING" = "true" ] && [ "$PYLINT_CHANGED" -gt 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Validation FAILED - $PYLINT_CHANGED Pylint-Odoo issues (pylint-blocking enabled)"
            exit 1
          elif [ "$FAIL_ON_WARNINGS" = "true" ] && [ "$RUFF_BLOCKING" = "true" ] && [ "$RUFF_CHANGED" -gt 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Validation FAILED - $RUFF_CHANGED Ruff issues (ruff-blocking enabled)"
            exit 1
          else
            echo "result=success" >> $GITHUB_OUTPUT
            echo "::notice::Validation PASSED (Odoo $ODOO_VERSION)"
            exit 0
          fi
