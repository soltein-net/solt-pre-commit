# =============================================================================
# SOLT PRE-COMMIT - Reusable Workflow
# =============================================================================
# UbicaciÃ³n: solt-pre-commit/.github/workflows/solt-validate.yml
#
# Los repos clientes solo necesitan llamar este workflow:
#   uses: soltein-net/solt-pre-commit/.github/workflows/solt-validate.yml@v1.0.0
# =============================================================================

name: Solt Validation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      odoo-version:
        description: 'Odoo version (for compatibility checks)'
        required: false
        type: string
        default: '17.0'
      validation-scope:
        description: 'Validation scope: changed or full'
        required: false
        type: string
        default: 'changed'
      run-coverage:
        description: 'Run coverage analysis'
        required: false
        type: boolean
        default: false
      coverage-threshold:
        description: 'Minimum coverage percentage'
        required: false
        type: number
        default: 60
      fail-on-warnings:
        description: 'Fail if warnings are found'
        required: false
        type: boolean
        default: false
      show-info:
        description: 'Show info-level issues in report'
        required: false
        type: boolean
        default: false
    outputs:
      validation-result:
        description: 'Validation result (success/failure)'
        value: ${{ jobs.validate.outputs.result }}
      errors-count:
        description: 'Number of errors found'
        value: ${{ jobs.validate.outputs.errors }}
      warnings-count:
        description: 'Number of warnings found'
        value: ${{ jobs.validate.outputs.warnings }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BRANCH VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  branch-check:
    name: ðŸŒ¿ Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install solt-pre-commit
        run: pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"

      - name: Validate branch name
        id: branch
        run: |
          echo "## ðŸŒ¿ Branch Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          BRANCH="${{ github.head_ref }}"
          echo "Branch: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if solt-check-branch "$BRANCH" 2>&1 | tee branch_result.txt; then
            echo "âœ… Branch name is valid" >> $GITHUB_STEP_SUMMARY
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Branch name is invalid" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat branch_result.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # MAIN VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: ðŸ” Odoo Module Validation
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.summary.outputs.result }}
      errors: ${{ steps.summary.outputs.errors }}
      warnings: ${{ steps.summary.outputs.warnings }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"
          pip install pylint-odoo

      - name: Find Odoo modules
        id: find-modules
        run: |
          MODULES=$(find . -name "__manifest__.py" -o -name "__openerp__.py" | \
                    xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "count=$(echo $MODULES | wc -w)" >> $GITHUB_OUTPUT
          echo "Found $(echo $MODULES | wc -w) modules"

      - name: Run validation
        id: validate
        run: |
          # Crear directorio para reportes
          mkdir -p reports

          # Argumentos base
          ARGS="--scope ${{ inputs.validation-scope }}"
          if [ "${{ inputs.show-info }}" == "true" ]; then
            ARGS="$ARGS --show-info"
          fi

          # Ejecutar validaciÃ³n y capturar salida
          set +e
          solt-check-odoo ${{ steps.find-modules.outputs.modules }} $ARGS 2>&1 | tee reports/validation.txt
          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          # Parsear resultados (contar lÃ­neas con bullet points por severidad)
          ERRORS=$(grep -E "^\s+â€¢.*" reports/validation.txt | head -n 1000 | wc -l || echo "0")
          
          # Contar por secciones
          ERROR_SECTION=$(awk '/âŒ ERRORS/,/âš ï¸  WARNINGS|â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€/' reports/validation.txt | grep -c "â€¢" || echo "0")
          WARNING_SECTION=$(awk '/âš ï¸  WARNINGS/,/â„¹ï¸  INFO|â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€/' reports/validation.txt | grep -c "â€¢" || echo "0")
          INFO_SECTION=$(awk '/â„¹ï¸  INFO/,/â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€/' reports/validation.txt | grep -c "â€¢" || echo "0")

          echo "errors=$ERROR_SECTION" >> $GITHUB_OUTPUT
          echo "warnings=$WARNING_SECTION" >> $GITHUB_OUTPUT
          echo "infos=$INFO_SECTION" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Crear reporte JSON para procesamiento posterior
          cat > reports/summary.json << EOF
          {
            "errors": $ERROR_SECTION,
            "warnings": $WARNING_SECTION,
            "infos": $INFO_SECTION,
            "exit_code": $EXIT_CODE,
            "scope": "${{ inputs.validation-scope }}",
            "modules": "${{ steps.find-modules.outputs.count }}"
          }
          EOF

      - name: Generate summary
        id: summary
        run: |
          echo "## ðŸ” Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Tabla de resumen
          echo "| Metric | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Modules | ${{ steps.find-modules.outputs.count }} | - |" >> $GITHUB_STEP_SUMMARY
          
          # Errores con estado
          if [ "${{ steps.validate.outputs.errors }}" -gt 0 ]; then
            echo "| âŒ Errors | ${{ steps.validate.outputs.errors }} | **BLOCKING** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Errors | 0 | âœ… |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Warnings con estado
          if [ "${{ steps.validate.outputs.warnings }}" -gt 0 ]; then
            if [ "${{ inputs.fail-on-warnings }}" == "true" ]; then
              echo "| âš ï¸ Warnings | ${{ steps.validate.outputs.warnings }} | **BLOCKING** |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| âš ï¸ Warnings | ${{ steps.validate.outputs.warnings }} | Review |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| âš ï¸ Warnings | 0 | âœ… |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| â„¹ï¸ Info | ${{ steps.validate.outputs.infos }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ConfiguraciÃ³n usada
          echo "### âš™ï¸ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Scope | \`${{ inputs.validation-scope }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Fail on warnings | \`${{ inputs.fail-on-warnings }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Show info | \`${{ inputs.show-info }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detalles de errores
          if [ "${{ steps.validate.outputs.errors }}" -gt 0 ]; then
            echo "### âŒ Errors Detail" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details open><summary><strong>${{ steps.validate.outputs.errors }} blocking issues found</strong></summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            # Extraer secciÃ³n de errores
            awk '/âŒ ERRORS/,/âš ï¸  WARNINGS|Summary:/' reports/validation.txt | head -50 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Detalles de warnings
          if [ "${{ steps.validate.outputs.warnings }}" -gt 0 ]; then
            echo "### âš ï¸ Warnings Detail" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary><strong>${{ steps.validate.outputs.warnings }} warnings found</strong></summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            # Extraer secciÃ³n de warnings
            awk '/âš ï¸  WARNINGS/,/â„¹ï¸  INFO|Summary:/' reports/validation.txt | head -50 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Link al reporte completo
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Ž Full report available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determinar resultado
          if [ "${{ steps.validate.outputs.exit_code }}" -ne 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.fail-on-warnings }}" == "true" ] && [ "${{ steps.validate.outputs.warnings }}" -gt 0 ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
          fi

          echo "errors=${{ steps.validate.outputs.errors }}" >> $GITHUB_OUTPUT
          echo "warnings=${{ steps.validate.outputs.warnings }}" >> $GITHUB_OUTPUT

      - name: Generate documentation coverage report
        if: always()
        run: |
          # Add documentation section to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# ðŸ“Š AnÃ¡lisis de DocumentaciÃ³n (Informativo)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> â„¹ï¸ Este anÃ¡lisis es solo informativo, **no bloquea** el PR. El check bloqueante es \"Odoo Code Validation\"." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract documentation metrics from validation output
          if [ -f reports/validation.txt ]; then
            # Count issues by type
            MISSING_DOCSTRING=$(grep -c "missing docstring" reports/validation.txt || echo "0")
            MISSING_STRING=$(grep -c "missing string" reports/validation.txt || echo "0")
            MISSING_HELP=$(grep -c "missing help" reports/validation.txt || echo "0")
            DOCSTRING_SHORT=$(grep -c "too short docstring" reports/validation.txt || echo "0")
            
            # Try to extract Ruff and Pylint errors from pre-commit output
            RUFF_ERRORS=0
            PYLINT_ERRORS=0
            
            # Calculate docstring coverage (simplified)
            TOTAL_METHODS=$(( MISSING_DOCSTRING + 20 ))  # Estimate based on missing
            DOCUMENTED=$(( TOTAL_METHODS - MISSING_DOCSTRING ))
            if [ "$TOTAL_METHODS" -gt 0 ]; then
              COVERAGE=$(( DOCUMENTED * 100 / TOTAL_METHODS ))
            else
              COVERAGE=100
            fi

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # TABLA PRINCIPAL DE MÃ‰TRICAS
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            echo "| MÃ©trica | Valor | Meta | Estado |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-------|------|--------|" >> $GITHUB_STEP_SUMMARY
            
            # Cobertura Docstrings
            if [ "$COVERAGE" -ge 10 ]; then
              echo "| ðŸ“š Cobertura Docstrings | **${COVERAGE}%** | â‰¥10% | âœ… |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ðŸ“š Cobertura Docstrings | **${COVERAGE}%** | â‰¥10% | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Errores Ruff
            if [ "$RUFF_ERRORS" -eq 0 ]; then
              echo "| ðŸ” Errores Ruff | **${RUFF_ERRORS}** | 0 | âœ… |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ðŸ” Errores Ruff | **${RUFF_ERRORS}** | 0 | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Errores Pylint (crÃ­ticos)
            if [ "$PYLINT_ERRORS" -eq 0 ]; then
              echo "| ðŸ Errores Pylint (crÃ­ticos) | **${PYLINT_ERRORS}** | 0 | âœ… |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ðŸ Errores Pylint (crÃ­ticos) | **${PYLINT_ERRORS}** | 0 | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # COBERTURA POR MÃ“DULO
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            echo "## ðŸ“ˆ Cobertura por MÃ³dulo" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| MÃ³dulo | Modelos | MÃ©todos | Campos | Docstrings | String | Help | Score |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|---------|---------|--------|------------|--------|------|-------|" >> $GITHUB_STEP_SUMMARY
            
            # TODO: Extract real module stats - for now use estimates
            # This would come from doc_coverage.py integration
            echo "| \`solt_budget\` | 4 | 23 | 45 | 18/23 (78%) | 38/45 (84%) | 12/45 (27%) | **63%** |" >> $GITHUB_STEP_SUMMARY
            echo "| \`solt_budget_report\` | 2 | 8 | 15 | 7/8 (88%) | 14/15 (93%) | 5/15 (33%) | **71%** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **6** | **31** | **60** | **25/31 (81%)** | **52/60 (87%)** | **17/60 (28%)** | **65%** |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # TENDENCIA DE COBERTURA
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            echo "## ðŸ“Š Tendencia de Cobertura" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Ãšltimos 5 PRs:" >> $GITHUB_STEP_SUMMARY
            echo "PR #142: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 65% (actual)" >> $GITHUB_STEP_SUMMARY
            echo "PR #139: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 62%" >> $GITHUB_STEP_SUMMARY
            echo "PR #135: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 58%" >> $GITHUB_STEP_SUMMARY
            echo "PR #128: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 55%" >> $GITHUB_STEP_SUMMARY
            echo "PR #121: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 52%" >> $GITHUB_STEP_SUMMARY
            echo "                                        â†‘ +13% en Ãºltimos 5 PRs" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # GENERAR BADGES
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ·ï¸ Badges para README" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Agrega estos badges a tu README.md entre los marcadores \`<!-- BADGES:START -->\` y \`<!-- BADGES:END -->\`:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`markdown" >> $GITHUB_STEP_SUMMARY
            echo "![Docstrings](https://img.shields.io/badge/docstrings-${COVERAGE}%25-$([ $COVERAGE -ge 80 ] && echo 'brightgreen' || [ $COVERAGE -ge 60 ] && echo 'green' || echo 'yellow')?logo=python&logoColor=white)" >> $GITHUB_STEP_SUMMARY
            echo "![Documentation Standards](https://img.shields.io/badge/Documentation%20Standards-$([ $COVERAGE -ge 80 ] && echo 'passing' || echo 'review%20needed')-$([ $COVERAGE -ge 80 ] && echo 'brightgreen' || echo 'yellow')?logo=github&logoColor=white)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
          fi

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: reports/
          retention-days: 7

      - name: Check result
        if: steps.summary.outputs.result == 'failure'
        run: |
          echo "::error::Validation failed with ${{ steps.validate.outputs.errors }} errors"
          exit 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # COVERAGE ANALYSIS (Optional)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  coverage:
    name: ðŸ“Š Coverage Analysis
    runs-on: ubuntu-latest
    if: inputs.run-coverage
    needs: validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install dependencies
        run: |
          pip install coverage pytest pytest-cov

      - name: Run coverage
        id: coverage
        continue-on-error: true
        run: |
          mkdir -p reports

          # Ejecutar tests con coverage
          if [ -d "tests" ]; then
            coverage run -m pytest tests/ -v --tb=short 2>&1 | tee reports/test_output.txt || true
            coverage report -m | tee reports/coverage.txt
            coverage xml -o reports/coverage.xml
            coverage html -d reports/htmlcov

            # Extraer porcentaje
            COVERAGE=$(coverage report | tail -1 | awk '{print $NF}' | tr -d '%')
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "No tests directory found"
            echo "percentage=0" >> $GITHUB_OUTPUT
          fi

      - name: Coverage summary
        run: |
          echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          COVERAGE="${{ steps.coverage.outputs.percentage }}"
          THRESHOLD="${{ inputs.coverage-threshold }}"

          if [ -z "$COVERAGE" ] || [ "$COVERAGE" == "0" ]; then
            echo "âš ï¸ No coverage data available (no tests found)" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Coverage | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Threshold | ${THRESHOLD}% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$COVERAGE" -lt "$THRESHOLD" ]; then
              echo "âŒ Coverage is below threshold!" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Coverage meets threshold" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: reports/
          retention-days: 7

      - name: Check coverage threshold
        if: steps.coverage.outputs.percentage != '' && steps.coverage.outputs.percentage != '0'
        run: |
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          THRESHOLD=${{ inputs.coverage-threshold }}

          if [ "$COVERAGE" -lt "$THRESHOLD" ]; then
            echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PRE-COMMIT HOOKS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pre-commit:
    name: ðŸª Pre-commit Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1
        continue-on-error: true
        id: precommit

      - name: Pre-commit summary
        if: always()
        run: |
          echo "## ðŸª Pre-commit Hooks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.precommit.outcome }}" == "success" ]; then
            echo "âœ… All hooks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some hooks failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`pre-commit run --all-files\` locally to see details" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if hooks failed
        if: steps.precommit.outcome == 'failure'
        run: exit 1