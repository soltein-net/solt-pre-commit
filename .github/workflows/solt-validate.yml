# =============================================================================
# SOLT PRE-COMMIT - Reusable Workflow (Optimized)
# =============================================================================
# EXECUTION: Only on pull_request - validates CHANGED files only
# Badges are updated separately via weekly schedule
# =============================================================================
name: Soltein Validation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      fail-on-warnings:
        description: 'Fail if warnings are found'
        required: false
        type: boolean
        default: false
      ruff-blocking:
        description: 'Make Ruff issues blocking'
        required: false
        type: boolean
        default: false
      pylint-blocking:
        description: 'Make Pylint-Odoo issues blocking'
        required: false
        type: boolean
        default: true
    outputs:
      validation-result:
        description: 'Validation result (success/failure)'
        value: ${{ jobs.validate.outputs.result }}
      errors-count:
        description: 'Number of errors found'
        value: ${{ jobs.validate.outputs.errors }}
      warnings-count:
        description: 'Number of warnings found'
        value: ${{ jobs.validate.outputs.warnings }}

jobs:
  # ---------------------------------------------------------------------------
  # BRANCH VALIDATION
  # ---------------------------------------------------------------------------
  branch-check:
    name: Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      - name: Install solt-pre-commit
        run: pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"
      - name: Validate branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "## Branch Validation" >> $GITHUB_STEP_SUMMARY
          echo "Branch: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          if solt-check-branch "$BRANCH"; then
            echo "✅ Branch name is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Branch name is invalid" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ---------------------------------------------------------------------------
  # MAIN VALIDATION (CHANGED files only)
  # ---------------------------------------------------------------------------
  validate:
    name: Odoo Module Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    outputs:
      result: ${{ steps.final-check.outputs.result }}
      errors: ${{ steps.summary.outputs.errors }}
      warnings: ${{ steps.summary.outputs.warnings }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"
          pip install pylint-odoo ruff

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }} --depth=1 || true

      - name: Get changed files
        id: changed
        run: |
          CHANGED_PY=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD -- '*.py' 2>/dev/null | tr '\n' ' ')
          CHANGED_ALL=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD 2>/dev/null | wc -l)

          EXISTING_PY=""
          for f in $CHANGED_PY; do [ -f "$f" ] && EXISTING_PY="$EXISTING_PY $f"; done

          echo "py_files=$(echo $EXISTING_PY | xargs)" >> $GITHUB_OUTPUT
          echo "py_count=$(echo $EXISTING_PY | wc -w | tr -d ' ')" >> $GITHUB_OUTPUT
          echo "total_count=$CHANGED_ALL" >> $GITHUB_OUTPUT

      - name: Find affected modules
        id: modules
        run: |
          MODULES=""
          for f in $(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD 2>/dev/null); do
            DIR=$(dirname "$f")
            while [ "$DIR" != "." ] && [ "$DIR" != "/" ]; do
              if [ -f "$DIR/__manifest__.py" ] || [ -f "$DIR/__openerp__.py" ]; then
                MODULES="$MODULES $DIR"
                break
              fi
              DIR=$(dirname "$DIR")
            done
          done
          MODULES=$(echo "$MODULES" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "count=$(echo $MODULES | wc -w | tr -d ' ')" >> $GITHUB_OUTPUT

      - name: Solt validation
        id: solt
        if: steps.modules.outputs.count != '0'
        continue-on-error: true
        env:
          SOLT_BASE_BRANCH: ${{ github.base_ref }}
        run: |
          mkdir -p reports
          START=$(date +%s)
          set +e
          solt-check-odoo ${{ steps.modules.outputs.modules }} --scope changed 2>&1 | tee reports/validation.txt
          CODE=${PIPESTATUS[0]}
          set -e
          echo "exit_code=$CODE" >> $GITHUB_OUTPUT
          echo "duration=$(($(date +%s) - START))" >> $GITHUB_OUTPUT
          exit $CODE

      - name: Ruff linting
        id: ruff
        if: steps.changed.outputs.py_count != '0'
        continue-on-error: true
        run: |
          ISSUES=0
          if [ -n "${{ steps.changed.outputs.py_files }}" ]; then
            ruff check ${{ steps.changed.outputs.py_files }} --output-format=concise 2>&1 | tee reports/ruff.txt || true
            ISSUES=$(grep -cE "^.+\.py:[0-9]+" reports/ruff.txt 2>/dev/null || echo "0")
          fi
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT

      - name: Pylint-Odoo linting
        id: pylint
        if: steps.changed.outputs.py_count != '0'
        continue-on-error: true
        run: |
          ISSUES=0
          if [ -n "${{ steps.changed.outputs.py_files }}" ]; then
            pylint --load-plugins=pylint_odoo --exit-zero ${{ steps.changed.outputs.py_files }} 2>&1 | \
              sed 's/\x1b\[[0-9;]*m//g' | tee reports/pylint.txt || true
            ISSUES=$(grep -cE "\.py:[0-9]+:.*\[" reports/pylint.txt 2>/dev/null || echo "0")
          fi
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT

      - name: Extract summary
        id: summary
        if: always()
        run: |
          ERRORS=0; WARNINGS=0
          if [ -f "reports/validation.txt" ]; then
            ERRORS=$(grep -oP "Errors:\s*\K\d+" reports/validation.txt 2>/dev/null | tail -1 || echo "0")
            WARNINGS=$(grep -oP "Warnings:\s*\K\d+" reports/validation.txt 2>/dev/null | tail -1 || echo "0")
          fi
          echo "errors=${ERRORS:-0}" >> $GITHUB_OUTPUT
          echo "warnings=${WARNINGS:-0}" >> $GITHUB_OUTPUT

      - name: Comment PR
        if: always()
        uses: actions/github-script@v7
        env:
          MODULE_COUNT: ${{ steps.modules.outputs.count }}
          CHANGED_FILES: ${{ steps.changed.outputs.total_count }}
          SOLT_EXIT: ${{ steps.solt.outputs.exit_code }}
          DURATION: ${{ steps.solt.outputs.duration }}
          ERRORS: ${{ steps.summary.outputs.errors }}
          WARNINGS: ${{ steps.summary.outputs.warnings }}
          RUFF_ISSUES: ${{ steps.ruff.outputs.issues }}
          PYLINT_ISSUES: ${{ steps.pylint.outputs.issues }}
          FAIL_ON_WARNINGS: ${{ inputs.fail-on-warnings }}
          RUFF_BLOCKING: ${{ inputs.ruff-blocking }}
          PYLINT_BLOCKING: ${{ inputs.pylint-blocking }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const fs = require('fs');
            const safeInt = (v, d = 0) => { const n = parseInt(v); return isNaN(n) ? d : n; };
            const prNumber = safeInt(process.env.PR_NUMBER);
            if (!prNumber) return;

            const moduleCount = safeInt(process.env.MODULE_COUNT);
            const changedFiles = safeInt(process.env.CHANGED_FILES);
            const soltExit = safeInt(process.env.SOLT_EXIT);
            const duration = safeInt(process.env.DURATION);
            const errors = safeInt(process.env.ERRORS);
            const warnings = safeInt(process.env.WARNINGS);
            const ruffIssues = safeInt(process.env.RUFF_ISSUES);
            const pylintIssues = safeInt(process.env.PYLINT_ISSUES);
            const failOnWarnings = process.env.FAIL_ON_WARNINGS === 'true';
            const ruffBlocking = process.env.RUFF_BLOCKING === 'true';
            const pylintBlocking = process.env.PYLINT_BLOCKING === 'true';

            const hasErrors = soltExit !== 0 || errors > 0;
            const hasBlockingWarnings = failOnWarnings && warnings > 0;
            const hasBlockingRuff = ruffBlocking && ruffIssues > 0;
            const hasBlockingPylint = pylintBlocking && failOnWarnings && pylintIssues > 0;
            const hasFailed = hasErrors || hasBlockingWarnings || hasBlockingRuff || hasBlockingPylint;

            const status = hasFailed ? ':x: Failed' : ':white_check_mark: Passed';
            const statusMsg = hasFailed
              ? '> :no_entry: **This PR has blocking issues.**'
              : '> :white_check_mark: **All checks passed.**';

            let body = `## :bar_chart: Validation Report\n\n${statusMsg}\n\n`;
            body += `| Metric | Value |\n|--------|-------|\n`;
            body += `| Status | ${status} |\n`;
            body += `| Modules | ${moduleCount} |\n`;
            body += `| Files | ${changedFiles} |\n`;
            body += `| Time | ${duration}s |\n\n`;

            body += `| Tool | Issues | Mode |\n|------|--------|------|\n`;
            body += `| solt-check-odoo | ${errors} err / ${warnings} warn | blocking |\n`;
            body += `| Ruff | ${ruffIssues} | ${ruffBlocking ? 'blocking' : 'info'} |\n`;
            body += `| Pylint-Odoo | ${pylintIssues} | ${pylintBlocking ? 'blocking' : 'info'} |\n\n`;

            if (errors > 0) {
              try {
                const lines = fs.readFileSync('reports/validation.txt', 'utf8')
                  .split('\n').filter(l => l.trim().startsWith('- ')).slice(0, 5);
                if (lines.length) body += `<details><summary>Issues</summary>\n\n\`\`\`\n${lines.join('\n')}\n\`\`\`\n</details>\n\n`;
              } catch (e) {}
            }

            body += `[:link: Logs](${process.env.WORKFLOW_URL}) | :robot: *solt-pre-commit*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber,
            });
            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('Validation Report'));

            if (botComment) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: botComment.id, body });
            } else {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body });
            }

      - name: Final check
        id: final-check
        if: always()
        run: |
          FAILED=0
          [ "${SOLT_EXIT:-0}" != "0" ] || [ "${ERRORS:-0}" -gt 0 ] && FAILED=1
          [ "${{ inputs.fail-on-warnings }}" = "true" ] && [ "${WARNINGS:-0}" -gt 0 ] && FAILED=1
          [ "${{ inputs.ruff-blocking }}" = "true" ] && [ "${RUFF:-0}" -gt 0 ] && FAILED=1
          [ "${{ inputs.pylint-blocking }}" = "true" ] && [ "${{ inputs.fail-on-warnings }}" = "true" ] && [ "${PYLINT:-0}" -gt 0 ] && FAILED=1

          if [ "$FAILED" = "1" ]; then
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "result=success" >> $GITHUB_OUTPUT
        env:
          SOLT_EXIT: ${{ steps.solt.outputs.exit_code }}
          ERRORS: ${{ steps.summary.outputs.errors }}
          WARNINGS: ${{ steps.summary.outputs.warnings }}
          RUFF: ${{ steps.ruff.outputs.issues }}
          PYLINT: ${{ steps.pylint.outputs.issues }}

  # ---------------------------------------------------------------------------
  # PRE-COMMIT HOOKS
  # ---------------------------------------------------------------------------
  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      - name: Run pre-commit
        run: |
          pip install pre-commit
          git fetch origin ${{ github.base_ref }} --depth=1
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          EXISTING=""; for f in $FILES; do [ -f "$f" ] && EXISTING="$EXISTING $f"; done
          [ -n "$EXISTING" ] && pre-commit run --files $EXISTING || true
