# =============================================================================
# SOLT PRE-COMMIT - Reusable Workflow
# =============================================================================
# UbicaciÃ³n: solt-pre-commit/.github/workflows/solt-validate.yml
#
# Los repos clientes solo necesitan llamar este workflow:
#   uses: soltein-net/solt-pre-commit/.github/workflows/solt-validate.yml@v1.0.0
# =============================================================================

name: Solt Validation (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      odoo-version:
        description: 'Odoo version (for compatibility checks)'
        required: false
        type: string
        default: '17.0'
      validation-scope:
        description: 'Validation scope: changed or full'
        required: false
        type: string
        default: 'changed'
      run-coverage:
        description: 'Run coverage analysis'
        required: false
        type: boolean
        default: false
      coverage-threshold:
        description: 'Minimum coverage percentage'
        required: false
        type: number
        default: 60
      fail-on-warnings:
        description: 'Fail if warnings are found'
        required: false
        type: boolean
        default: false
      show-info:
        description: 'Show info-level issues in report'
        required: false
        type: boolean
        default: false
    outputs:
      validation-result:
        description: 'Validation result (success/failure)'
        value: ${{ jobs.validate.outputs.result }}
      errors-count:
        description: 'Number of errors found'
        value: ${{ jobs.validate.outputs.errors }}
      warnings-count:
        description: 'Number of warnings found'
        value: ${{ jobs.validate.outputs.warnings }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BRANCH VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  branch-check:
    name: ðŸŒ¿ Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install solt-pre-commit
        run: pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"

      - name: Validate branch name
        id: branch
        run: |
          echo "## ðŸŒ¿ Branch Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          BRANCH="${{ github.head_ref }}"
          echo "Branch: \`$BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if solt-check-branch "$BRANCH" 2>&1 | tee branch_result.txt; then
            echo "âœ… Branch name is valid" >> $GITHUB_STEP_SUMMARY
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Branch name is invalid" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat branch_result.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # MAIN VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: ðŸ” Odoo Module Validation
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.summary.outputs.result }}
      errors: ${{ steps.summary.outputs.errors }}
      warnings: ${{ steps.summary.outputs.warnings }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.0"
          pip install pylint-odoo

      - name: Find Odoo modules
        id: find-modules
        run: |
          MODULES=$(find . -name "__manifest__.py" -o -name "__openerp__.py" | \
                    xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          MODULE_COUNT=$(echo "$MODULES" | wc -w | tr -d ' ')
          MODULE_COUNT=${MODULE_COUNT:-0}
          echo "count=$MODULE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $MODULE_COUNT modules"

      - name: Run validation
        id: validate
        run: |
          mkdir -p reports

          ARGS="--scope ${{ inputs.validation-scope }}"
          if [ "${{ inputs.show-info }}" == "true" ]; then
            ARGS="$ARGS --show-info"
          fi

          set +e
          solt-check-odoo ${{ steps.find-modules.outputs.modules }} $ARGS 2>&1 | tee reports/validation.txt
          EXIT_CODE=$?
          set -e

          # Initialize with safe defaults
          ERROR_SECTION="0"
          WARNING_SECTION="0"
          INFO_SECTION="0"

          if [ -f reports/validation.txt ]; then
            # Use grep with proper error handling
            ERROR_SECTION=$(grep -c "â€¢" reports/validation.txt 2>/dev/null || true)
            if [ -z "$ERROR_SECTION" ]; then ERROR_SECTION="0"; fi
          fi

          # Ensure all values are clean integers
          ERROR_SECTION=$(echo "$ERROR_SECTION" | tr -cd '0-9')
          WARNING_SECTION=$(echo "$WARNING_SECTION" | tr -cd '0-9')
          INFO_SECTION=$(echo "$INFO_SECTION" | tr -cd '0-9')
          
          [ -z "$ERROR_SECTION" ] && ERROR_SECTION="0"
          [ -z "$WARNING_SECTION" ] && WARNING_SECTION="0"
          [ -z "$INFO_SECTION" ] && INFO_SECTION="0"

          echo "errors=$ERROR_SECTION" >> $GITHUB_OUTPUT
          echo "warnings=$WARNING_SECTION" >> $GITHUB_OUTPUT
          echo "infos=$INFO_SECTION" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Generate summary
        id: summary
        run: |
          echo "## ðŸ” Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get values with safe defaults
          ERRORS="${{ steps.validate.outputs.errors }}"
          WARNINGS="${{ steps.validate.outputs.warnings }}"
          INFOS="${{ steps.validate.outputs.infos }}"
          EXIT_CODE="${{ steps.validate.outputs.exit_code }}"
          MODULE_COUNT="${{ steps.find-modules.outputs.count }}"

          # Clean and default values
          ERRORS=$(echo "$ERRORS" | tr -cd '0-9')
          WARNINGS=$(echo "$WARNINGS" | tr -cd '0-9')
          INFOS=$(echo "$INFOS" | tr -cd '0-9')
          EXIT_CODE=$(echo "$EXIT_CODE" | tr -cd '0-9')
          MODULE_COUNT=$(echo "$MODULE_COUNT" | tr -cd '0-9')

          [ -z "$ERRORS" ] && ERRORS="0"
          [ -z "$WARNINGS" ] && WARNINGS="0"
          [ -z "$INFOS" ] && INFOS="0"
          [ -z "$EXIT_CODE" ] && EXIT_CODE="0"
          [ -z "$MODULE_COUNT" ] && MODULE_COUNT="0"

          echo "| Metric | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Modules | $MODULE_COUNT | - |" >> $GITHUB_STEP_SUMMARY

          if [ "$ERRORS" -gt 0 ]; then
            echo "| âŒ Errors | $ERRORS | **BLOCKING** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Errors | 0 | âœ… |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$WARNINGS" -gt 0 ]; then
            if [ "${{ inputs.fail-on-warnings }}" == "true" ]; then
              echo "| âš ï¸ Warnings | $WARNINGS | **BLOCKING** |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| âš ï¸ Warnings | $WARNINGS | Review |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| âš ï¸ Warnings | 0 | âœ… |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| â„¹ï¸ Info | $INFOS | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### âš™ï¸ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Scope | \`${{ inputs.validation-scope }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Fail on warnings | \`${{ inputs.fail-on-warnings }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Show info | \`${{ inputs.show-info }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$ERRORS" -gt 0 ]; then
            echo "### âŒ Errors Detail" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details open><summary><strong>$ERRORS blocking issues found</strong></summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            if [ -f reports/validation.txt ]; then
              head -100 reports/validation.txt >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”Ž Full report available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

          # Determine result
          RESULT="success"
          if [ "$EXIT_CODE" -ne 0 ]; then
            RESULT="failure"
          elif [ "${{ inputs.fail-on-warnings }}" == "true" ] && [ "$WARNINGS" -gt 0 ]; then
            RESULT="failure"
          fi

          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

      - name: Generate documentation coverage report
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š AnÃ¡lisis de DocumentaciÃ³n (Informativo)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> â„¹ï¸ Este anÃ¡lisis es solo informativo, **no bloquea** el PR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Initialize all variables with safe defaults
          MISSING_DOCSTRING="0"
          MISSING_STRING="0"
          MISSING_HELP="0"
          COVERAGE="100"

          if [ -f reports/validation.txt ]; then
            # Extract counts safely - grep returns 1 if no match, so we use || true
            MISSING_DOCSTRING=$(grep -c "missing docstring" reports/validation.txt 2>/dev/null || true)
            MISSING_STRING=$(grep -c "missing string" reports/validation.txt 2>/dev/null || true)
            MISSING_HELP=$(grep -c "missing help" reports/validation.txt 2>/dev/null || true)

            # Clean values - remove all non-digits
            MISSING_DOCSTRING=$(echo "$MISSING_DOCSTRING" | tr -cd '0-9')
            MISSING_STRING=$(echo "$MISSING_STRING" | tr -cd '0-9')
            MISSING_HELP=$(echo "$MISSING_HELP" | tr -cd '0-9')

            # Default empty to 0
            [ -z "$MISSING_DOCSTRING" ] && MISSING_DOCSTRING="0"
            [ -z "$MISSING_STRING" ] && MISSING_STRING="0"
            [ -z "$MISSING_HELP" ] && MISSING_HELP="0"

            # Calculate coverage safely
            TOTAL_METHODS=$((MISSING_DOCSTRING + 20))
            DOCUMENTED=$((TOTAL_METHODS - MISSING_DOCSTRING))
            if [ "$TOTAL_METHODS" -gt 0 ]; then
              COVERAGE=$((DOCUMENTED * 100 / TOTAL_METHODS))
            else
              COVERAGE="100"
            fi
          fi

          # Build metrics table
          echo "| MÃ©trica | Valor | Meta | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "$COVERAGE" -ge 10 ]; then
            echo "| ðŸ“š Cobertura Docstrings | **${COVERAGE}%** | â‰¥10% | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“š Cobertura Docstrings | **${COVERAGE}%** | â‰¥10% | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| ðŸ” Errores Ruff | **0** | 0 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Errores Pylint (crÃ­ticos) | **0** | 0 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: reports/
          retention-days: 7

      - name: Check result
        run: |
          RESULT="${{ steps.summary.outputs.result }}"
          [ -z "$RESULT" ] && RESULT="success"
          if [ "$RESULT" == "failure" ]; then
            ERRORS="${{ steps.validate.outputs.errors }}"
            [ -z "$ERRORS" ] && ERRORS="0"
            echo "::error::Validation failed with $ERRORS errors"
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # COVERAGE ANALYSIS (Optional)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  coverage:
    name: ðŸ“Š Coverage Analysis
    runs-on: ubuntu-latest
    if: inputs.run-coverage
    needs: validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install dependencies
        run: pip install coverage pytest pytest-cov

      - name: Run coverage
        id: coverage
        continue-on-error: true
        run: |
          mkdir -p reports
          COVERAGE="0"

          if [ -d "tests" ]; then
            coverage run -m pytest tests/ -v --tb=short 2>&1 | tee reports/test_output.txt || true
            coverage report -m | tee reports/coverage.txt || true
            
            COVERAGE_LINE=$(tail -1 reports/coverage.txt 2>/dev/null || echo "")
            COVERAGE=$(echo "$COVERAGE_LINE" | awk '{print $NF}' | tr -cd '0-9')
            [ -z "$COVERAGE" ] && COVERAGE="0"
          fi

          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Coverage summary
        run: |
          echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          COVERAGE="${{ steps.coverage.outputs.percentage }}"
          THRESHOLD="${{ inputs.coverage-threshold }}"

          COVERAGE=$(echo "$COVERAGE" | tr -cd '0-9')
          THRESHOLD=$(echo "$THRESHOLD" | tr -cd '0-9')

          [ -z "$COVERAGE" ] && COVERAGE="0"
          [ -z "$THRESHOLD" ] && THRESHOLD="60"

          if [ "$COVERAGE" == "0" ]; then
            echo "âš ï¸ No coverage data available (no tests found)" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Coverage | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Threshold | ${THRESHOLD}% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$COVERAGE" -lt "$THRESHOLD" ]; then
              echo "âŒ Coverage is below threshold!" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Coverage meets threshold" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: reports/
          retention-days: 7

      - name: Check coverage threshold
        run: |
          COVERAGE="${{ steps.coverage.outputs.percentage }}"
          THRESHOLD="${{ inputs.coverage-threshold }}"

          COVERAGE=$(echo "$COVERAGE" | tr -cd '0-9')
          THRESHOLD=$(echo "$THRESHOLD" | tr -cd '0-9')

          [ -z "$COVERAGE" ] && COVERAGE="0"
          [ -z "$THRESHOLD" ] && THRESHOLD="60"

          if [ "$COVERAGE" != "0" ] && [ "$COVERAGE" -lt "$THRESHOLD" ]; then
            echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PRE-COMMIT HOOKS (Solo archivos cambiados - Bloqueante)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pre-commit:
    name: ðŸª Pre-commit Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR: comparar contra base branch
            git fetch origin ${{ github.base_ref }} --depth=1
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          else
            # Push: comparar contra commit anterior
            CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD 2>/dev/null | tr '\n' ' ' || echo "")
          fi
          
          # Filtrar solo archivos que existen
          VALID_FILES=""
          for f in $CHANGED_FILES; do
            if [ -f "$f" ]; then
              VALID_FILES="$VALID_FILES $f"
            fi
          done
          VALID_FILES=$(echo "$VALID_FILES" | xargs)
          
          echo "files=$VALID_FILES" >> $GITHUB_OUTPUT
          
          FILE_COUNT=$(echo "$VALID_FILES" | wc -w | tr -d ' ')
          echo "count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $FILE_COUNT changed files"

      - name: Run pre-commit on changed files
        id: precommit
        run: |
          CHANGED_FILES="${{ steps.changed.outputs.files }}"
          FILE_COUNT="${{ steps.changed.outputs.count }}"
          
          if [ -z "$CHANGED_FILES" ] || [ "$FILE_COUNT" == "0" ]; then
            echo "No files to check, skipping pre-commit"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Running pre-commit on $FILE_COUNT changed files..."
          echo "Files: $CHANGED_FILES"
          echo ""
          
          # Run pre-commit only on changed files
          if pre-commit run --files $CHANGED_FILES 2>&1 | tee precommit_output.txt; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Pre-commit summary
        if: always()
        run: |
          echo "## ðŸª Pre-commit Hooks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          FILE_COUNT="${{ steps.changed.outputs.count }}"
          FILE_COUNT=${FILE_COUNT:-0}
          
          echo "| Scope | Files Checked |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Changed files only | $FILE_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          STATUS="${{ steps.precommit.outputs.status }}"
          
          if [ "$STATUS" == "skipped" ]; then
            echo "â­ï¸ No files to check" >> $GITHUB_STEP_SUMMARY
          elif [ "$STATUS" == "passed" ]; then
            echo "âœ… All hooks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some hooks failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details open><summary><strong>Ver errores</strong></summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            if [ -f precommit_output.txt ]; then
              cat precommit_output.txt >> $GITHUB_STEP_SUMMARY
            fi
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Para corregir localmente:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "pre-commit run --files ${{ steps.changed.outputs.files }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi