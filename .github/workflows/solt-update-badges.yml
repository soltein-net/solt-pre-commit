# =============================================================================
# SOLT PRE-COMMIT - Weekly Badge Update (Reusable)
# =============================================================================
# Version: 1.0.1
# Runs weekly to update documentation coverage badges
# Single job structure for efficiency
# =============================================================================
name: Update Badges (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use (auto-detected if not set)'
        required: false
        type: string
        default: ''
      odoo-version:
        description: 'Odoo version override (auto-detected from branch if not set)'
        required: false
        type: string
        default: ''
      gist-id:
        description: 'Gist ID for badge storage (default: Soltein central gist)'
        required: false
        type: string
        default: '147d543a086f6735d1ffa02172766e86'
      badge-filename-prefix:
        description: 'Prefix for badge filenames in gist (default: repository name)'
        required: false
        type: string
        default: ''
      docstring-threshold:
        description: 'Minimum docstring coverage to pass'
        required: false
        type: number
        default: 80
      branch:
        description: 'Branch to analyze (default: auto-detect main branch)'
        required: false
        type: string
        default: ''
    secrets:
      GIST_SECRET:
        description: 'GitHub token for updating gist badges'
        required: true

jobs:
  Update-Badges:
    name: Documentation Badges
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref_name }}
          fetch-depth: 1

      - name: Detect versions
        id: detect
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

          BRANCH="${{ inputs.branch || github.ref_name }}"
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT

          INPUT_ODOO="${{ inputs.odoo-version }}"
          INPUT_PYTHON="${{ inputs.python-version }}"

          if [ -n "$INPUT_ODOO" ]; then
            ODOO_VERSION="$INPUT_ODOO"
          else
            ODOO_VERSION=""
            if [[ "$BRANCH" =~ ^([0-9]+\.[0-9]+) ]]; then
              ODOO_VERSION="${BASH_REMATCH[1]}"
            fi
            if [ -z "$ODOO_VERSION" ] && [[ "$BRANCH" =~ ^[a-z]+/([0-9]+\.[0-9]+) ]]; then
              ODOO_VERSION="${BASH_REMATCH[1]}"
            fi
            if [ -z "$ODOO_VERSION" ]; then
              MANIFEST_VERSION=$(find . -name "__manifest__.py" -exec grep -h '"version"' {} \; 2>/dev/null | head -1 | grep -oE '[0-9]+\.[0-9]+' | head -1 || echo "")
              if [ -n "$MANIFEST_VERSION" ]; then
                ODOO_VERSION="$MANIFEST_VERSION"
              fi
            fi
            if [ -z "$ODOO_VERSION" ]; then
              ODOO_VERSION="17.0"
            fi
          fi

          if [ -n "$INPUT_PYTHON" ]; then
            PYTHON_VERSION="$INPUT_PYTHON"
          else
            case "$ODOO_VERSION" in
              16.0*|17.0*) PYTHON_VERSION="3.10" ;;
              18.0*) PYTHON_VERSION="3.11" ;;
              19.0*|20.0*|21.0*) PYTHON_VERSION="3.12" ;;
              *) PYTHON_VERSION="3.11" ;;
            esac
          fi

          echo "odoo_version=$ODOO_VERSION" >> $GITHUB_OUTPUT
          echo "python_version=$PYTHON_VERSION" >> $GITHUB_OUTPUT
          echo "::notice::Repo: $REPO_NAME, Odoo: $ODOO_VERSION, Python: $PYTHON_VERSION"

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.detect.outputs.python_version }}
          cache: 'pip'

      - name: Collect metrics
        id: metrics
        env:
          ODOO_VERSION: ${{ steps.detect.outputs.odoo_version }}
          REPO_NAME: ${{ steps.detect.outputs.repo_name }}
        run: |
          pip install --upgrade pip
          pip install "git+https://github.com/soltein-net/solt-pre-commit.git@v1.0.1"

          MODULES=$(find . -name "__manifest__.py" -o -name "__openerp__.py" | xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          MODULE_COUNT=$(echo "$MODULES" | wc -w | tr -d ' ')

          echo "Found $MODULE_COUNT modules for $REPO_NAME (Odoo $ODOO_VERSION)"

          solt-check-odoo $MODULES --scope full --odoo-version "$ODOO_VERSION" 2>&1 | tee output.txt || true

          DOC_COV=$(grep -oP "docstring_cov=\K[0-9.]+" output.txt 2>/dev/null | head -1 || echo "0")
          STRING_COV=$(grep -oP "string_cov=\K[0-9.]+" output.txt 2>/dev/null | head -1 || echo "0")
          HELP_COV=$(grep -oP "help_cov=\K[0-9.]+" output.txt 2>/dev/null | head -1 || echo "0")

          DOC_COV=${DOC_COV%.*}
          STRING_COV=${STRING_COV%.*}
          HELP_COV=${HELP_COV%.*}

          case "$DOC_COV" in ''|*[!0-9]*) DOC_COV=0 ;; esac
          case "$STRING_COV" in ''|*[!0-9]*) STRING_COV=0 ;; esac
          case "$HELP_COV" in ''|*[!0-9]*) HELP_COV=0 ;; esac

          THRESHOLD=${{ inputs.docstring-threshold }}
          if [ "$DOC_COV" -ge "$THRESHOLD" ]; then
            STATUS="passing"
          else
            STATUS="failing"
          fi

          echo "docstring_cov=$DOC_COV" >> $GITHUB_OUTPUT
          echo "string_cov=$STRING_COV" >> $GITHUB_OUTPUT
          echo "help_cov=$HELP_COV" >> $GITHUB_OUTPUT
          echo "docs_status=$STATUS" >> $GITHUB_OUTPUT
          echo "module_count=$MODULE_COUNT" >> $GITHUB_OUTPUT

          echo "## Badge Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | **$REPO_NAME** |" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo Version | **$ODOO_VERSION** |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Version | ${{ steps.detect.outputs.python_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Modules | $MODULE_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Docstrings | $DOC_COV% |" >> $GITHUB_STEP_SUMMARY
          echo "| Field strings | $STRING_COV% |" >> $GITHUB_STEP_SUMMARY
          echo "| Field help | $HELP_COV% |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | $STATUS |" >> $GITHUB_STEP_SUMMARY

      - name: Determine badge prefix
        id: prefix
        run: |
          if [ -n "${{ inputs.badge-filename-prefix }}" ]; then
            PREFIX="${{ inputs.badge-filename-prefix }}"
          else
            PREFIX="${{ steps.detect.outputs.repo_name }}"
          fi
          echo "value=$PREFIX" >> $GITHUB_OUTPUT

      - name: Update docstrings badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: ${{ inputs.gist-id }}
          filename: ${{ steps.prefix.outputs.value }}-${{ steps.detect.outputs.odoo_version }}-docstrings.json
          label: "docstrings (${{ steps.detect.outputs.odoo_version }})"
          message: "${{ steps.metrics.outputs.docstring_cov }}%"
          valColorRange: ${{ steps.metrics.outputs.docstring_cov }}
          minColorRange: 0
          maxColorRange: 100
          namedLogo: python
          logoColor: white

      - name: Update status badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: ${{ inputs.gist-id }}
          filename: ${{ steps.prefix.outputs.value }}-${{ steps.detect.outputs.odoo_version }}-docs-status.json
          label: "Docs (${{ steps.detect.outputs.odoo_version }})"
          message: ${{ steps.metrics.outputs.docs_status }}
          color: ${{ steps.metrics.outputs.docs_status == 'passing' && 'brightgreen' || 'red' }}
          namedLogo: github
          logoColor: white
